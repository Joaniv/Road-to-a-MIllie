<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road to a Millie | Pro Terminal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        millie: {
                            bg: 'var(--bg-color)',
                            card: 'var(--card-bg)',
                            border: 'var(--border-color)',
                            text: 'var(--text-color)',
                            muted: 'var(--muted-color)',
                            input: 'var(--input-bg)',
                            accent: 'var(--accent-color)',
                            green: 'var(--green-color)',
                            red: 'var(--red-color)',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            /* Default Dark Theme */
            --bg-color: #050b14;
            --card-bg: rgba(30, 41, 59, 0.4);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-color: #f8fafc;
            --muted-color: #94a3b8;
            --input-bg: rgba(15, 23, 42, 0.6);
            --accent-color: #00f2ff; /* Cyan Neon */
            --green-color: #10b981;
            --red-color: #ef4444;
            --backdrop: blur(12px);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        /* Professional Card Style */
        .pro-panel {
            background-color: #171717;
            border: 1px solid #262626;
            border-radius: 4px; /* Sharper corners */
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .input-group label {
            display: block;
            font-size: 0.65rem;
            color: #a3a3a3;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            background-color: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 0.5rem;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            transition: border-color 0.2s;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .paste-zone {
            border: 1px dashed #444;
            transition: all 0.2s ease;
        }
        .paste-zone:focus-within {
            border-color: #3b82f6;
            background: #111;
        }

        /* Professional Nav Tabs */
        .nav-btn.active {
            color: #fff;
            background-color: #262626;
            border-bottom: 2px solid #3b82f6;
        }
        .nav-btn {
            color: #737373;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .nav-btn:hover {
            color: #d4d4d4;
            background-color: #1a1a1a;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #10b981;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 12px;
            position: fixed;
            z-index: 100;
            bottom: 30px;
            right: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s;
            font-size: 0.875rem;
            font-weight: 500;
        }
        #toast.show {
            visibility: visible;
            transform: translateY(0);
            opacity: 1;
        }

        /* Table Styling */
        table th {
            font-weight: 600;
            letter-spacing: 0.05em;
            color: #737373;
        }
        table td {
            border-bottom: 1px solid #262626;
        }
        table tr:last-child td {
            border-bottom: none;
        }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #262626;
            border-radius: 2px;
        }
        
        /* Company Logo Style */
        .company-logo {
            width: 20px;
            height: 20px;
            object-fit: contain;
            border-radius: 50%;
            background: white;
            padding: 1px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 6px;
        }
        #valLogo {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin-right: 8px;
            background: #222;
        }
        
        /* Transition utility for opening/closing */
        .panel-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 2000px;
            opacity: 1;
            overflow: hidden;
        }
        .panel-content.closed {
            max-height: 0;
            opacity: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4 relative bg-[#050505]">

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="pro-panel p-8 rounded-md max-w-sm w-full relative bg-[#171717] border border-[#333]">
            <button onclick="document.getElementById('authModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold mb-6 text-white text-center">Cloud Access</h2>
            
            <div class="space-y-4">
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="authEmail" class="ws-input" placeholder="name@example.com">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="authPass" class="ws-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="handleLogin()" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 rounded-sm text-sm transition-colors">LOG IN</button>
                    <button onclick="handleSignUp()" class="flex-1 bg-[#262626] hover:bg-[#333] border border-gray-600 text-white font-bold py-2 rounded-sm text-sm transition-colors">SIGN UP</button>
                </div>
            </div>
            <p class="text-[10px] text-gray-500 mt-4 text-center">Data syncs automatically.</p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-sm hidden">
        <div class="bg-[#171717] border border-[#333] p-6 rounded-md shadow-2xl max-w-sm w-full">
            <h3 class="text-white font-bold text-lg mb-2">Confirm Deletion</h3>
            <p id="confirmMessage" class="text-gray-400 text-sm mb-6">Are you sure you want to remove this item?</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeConfirm()" class="px-4 py-2 text-sm text-gray-300 hover:text-white transition-colors bg-[#262626] hover:bg-[#333] rounded-sm">Cancel</button>
                <button id="confirmBtn" class="px-4 py-2 text-sm bg-red-700 hover:bg-red-600 text-white rounded-sm transition-colors shadow-lg shadow-red-900/20">Delete</button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="pro-panel p-8 rounded-md max-w-md w-full relative">
            <button onclick="document.getElementById('apiModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold mb-4 text-white">System Configuration</h2>
            <p class="text-xs text-gray-400 mb-4">API Keys are stored locally in your browser.</p>
            <input type="password" id="apiKeyInput" class="w-full bg-black border border-[#333] rounded-sm p-3 text-white mb-4 focus:outline-none focus:border-blue-500 text-sm font-mono" placeholder="Gemini API Key">
            <button onclick="saveApiKey()" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 rounded-sm transition-colors text-sm">SAVE CONFIGURATION</button>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast">Operation Successful</div>

    <!-- Main Content -->
    <main class="w-full max-w-7xl z-10 relative">
        
        <!-- Header -->
        <header class="mb-6 border-b border-[#262626] pb-6">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight text-white mb-1">
                        ROAD TO A MILLIE
                    </h1>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <p class="text-gray-500 font-mono text-[10px] tracking-widest uppercase">
                            Professional Investment Suite v2.0
                        </p>
                    </div>
                </div>
                
                <!-- Auth & Settings Area -->
                <div class="text-right flex items-center gap-4 justify-end">
                    <!-- Auth Section -->
                    <div id="auth-section">
                        <!-- Content injected via JS -->
                        <button onclick="document.getElementById('authModal').classList.remove('hidden')" class="text-xs font-bold bg-blue-900/30 text-blue-400 border border-blue-800 px-3 py-1.5 rounded-sm hover:bg-blue-800/50 transition-colors">
                            LOGIN / SIGN UP
                        </button>
                    </div>

                    <div class="h-4 w-px bg-[#333]"></div>

                    <button onclick="document.getElementById('apiModal').classList.remove('hidden')" class="text-xs text-gray-500 hover:text-white transition-colors flex items-center gap-1 font-bold uppercase tracking-wider">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        API
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex gap-1 bg-[#171717] p-1 rounded-md border border-[#262626] w-full max-w-lg">
                <button onclick="switchTool('valuation')" id="nav-valuation" class="nav-btn active flex-1 py-2 text-[11px] font-bold uppercase tracking-wide rounded-sm">Valuation Model</button>
                <button onclick="switchTool('portfolio')" id="nav-portfolio" class="nav-btn flex-1 py-2 text-[11px] font-bold uppercase tracking-wide rounded-sm">Portfolio Tracker</button>
                <button onclick="switchTool('watchlist')" id="nav-watchlist" class="nav-btn flex-1 py-2 text-[11px] font-bold uppercase tracking-wide rounded-sm">Watchlist</button>
                <button onclick="switchTool('compound')" id="nav-compound" class="nav-btn flex-1 py-2 text-[11px] font-bold uppercase tracking-wide rounded-sm">Compound</button>
            </div>
        </header>

        <!-- TOOL 1: VALUATION TERMINAL -->
        <div id="view-valuation" class="tool-view grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- LEFT COLUMN: Smart Input -->
            <div class="lg:col-span-5">
                <div class="pro-panel p-5">
                    
                    <!-- Mode Toggle -->
                    <div class="flex border-b border-[#262626] pb-3 mb-4">
                        <button onclick="setMode('smart')" id="btnSmart" class="flex-1 text-xs font-bold text-blue-500 border-b-2 border-blue-500 pb-2">SMART EXTRACT</button>
                        <button onclick="setMode('manual')" id="btnManual" class="flex-1 text-xs font-bold text-gray-500 pb-2 hover:text-white transition-colors">MANUAL ENTRY</button>
                    </div>

                    <!-- SMART PASTE SECTION -->
                    <div id="smartSection">
                        <div class="mb-4">
                            <label>Target Ticker</label>
                            <div class="flex gap-2 items-center">
                                <!-- Logo Placeholder -->
                                <img id="valLogo" class="company-logo hidden" alt="" onerror="this.style.display='none'">
                                <input type="text" id="smartTicker" class="bg-black border border-[#333] rounded-sm p-2 text-white w-24 text-center font-bold uppercase" placeholder="AAPL" onchange="handleTickerChange(this.value)">
                                <button onclick="openDataSource()" class="flex-1 bg-[#262626] hover:bg-[#333] border border-[#333] text-gray-300 text-xs font-bold rounded-sm flex items-center justify-center gap-2 transition-colors">
                                    <span>Open Yahoo Finance</span>
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label>Paste Data Source (Ctrl+A, Ctrl+C)</label>
                            
                            <!-- Language Selector -->
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-[10px] text-gray-500 uppercase font-bold">Locale:</span>
                                <select id="pasteLanguage" class="bg-[#262626] border border-[#333] rounded-sm px-2 py-0.5 text-[10px] text-gray-300 focus:outline-none cursor-pointer">
                                    <option value="en">English (US Format)</option>
                                    <option value="es">Espa√±ol (EU Format)</option>
                                    <option value="fr">Fran√ßais (EU Format)</option>
                                </select>
                            </div>

                            <textarea id="pasteArea" class="paste-zone w-full h-32 bg-black rounded-sm p-2 text-[10px] text-gray-400 font-mono resize-none focus:outline-none" placeholder="Paste data from Yahoo Finance here..."></textarea>
                        </div>

                        <button onclick="parseAndFill()" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 rounded-sm mb-4 transition-colors flex items-center justify-center gap-2 text-xs tracking-wide">
                            <span>EXTRACT FINANCIALS</span>
                            <span id="extractStatus" class="hidden text-[10px] bg-black/30 px-2 py-0.5 rounded">Reading...</span>
                        </button>
                    </div>

                    <!-- FORM -->
                    <form id="calcForm" onsubmit="event.preventDefault(); runAnalysis();" class="space-y-3 mt-6 border-t border-[#262626] pt-4">
                        
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-gray-400 uppercase">Valuation Inputs</span>
                            <span id="dataQualityBadge" class="text-[9px] bg-[#262626] text-gray-500 px-2 py-0.5 rounded border border-[#333]">NO DATA</span>
                        </div>

                        <!-- Core -->
                        <div class="grid grid-cols-3 gap-2">
                            <div class="input-group">
                                <label>Price</label>
                                <input type="text" id="price" required>
                            </div>
                            <div class="input-group">
                                <label>Shares (B)</label>
                                <input type="text" id="shares" required>
                            </div>
                            <div class="input-group">
                                <label>Raw Beta</label>
                                <input type="text" id="beta" placeholder="1.0">
                            </div>
                        </div>

                        <!-- Financials -->
                        <div class="grid grid-cols-2 gap-2">
                            <div class="input-group">
                                <div class="flex justify-between items-center mb-1">
                                    <label class="!mb-0">Net Income (TTM)</label>
                                    <button type="button" onclick="rollForwardNI()" class="text-[9px] bg-[#262626] hover:bg-[#333] text-gray-400 px-1.5 rounded border border-[#333] transition-colors" title="Project forward 1 year">‚è© Roll Fwd</button>
                                </div>
                                <input type="text" id="ni_ttm">
                            </div>
                            <div class="input-group">
                                <div class="flex justify-between items-center mb-1">
                                    <label class="!mb-0">FCF (TTM)</label>
                                    <button type="button" onclick="rollForward()" class="text-[9px] bg-[#262626] hover:bg-[#333] text-gray-400 px-1.5 rounded border border-[#333] transition-colors" title="Project forward 1 year">‚è© Roll Fwd</button>
                                </div>
                                <input type="text" id="fcf_ttm" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div class="input-group">
                                <label>Total Cash</label>
                                <input type="text" id="cash">
                            </div>
                            <div class="input-group">
                                <label>Total Debt</label>
                                <input type="text" id="debt">
                            </div>
                        </div>

                        <!-- Growth & Risk Assumptions -->
                        <div class="p-3 bg-[#111] rounded border border-[#262626]">
                            <label class="block text-[10px] text-gray-400 uppercase mb-2 text-center font-bold">Assumptions</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="input-group">
                                    <label>Growth Rate (%)</label>
                                    <input type="text" id="growth_rate" value="10.0">
                                </div>
                                <div class="input-group">
                                    <label>10Y Yield (RFR %)</label>
                                    <input type="text" id="rfr" value="4.2">
                                </div>
                            </div>
                            <div class="input-group mt-2">
                                <label>Valuation Model</label>
                                <select id="sector">
                                    <option value="tech">Standard Tech (DCF 15x Exit)</option>
                                    <option value="high_tech">High Growth (DCF 30x Exit)</option>
                                    <option value="industrial">Industrial (DCF 7x Exit)</option>
                                    <option value="bank">Financials (DDM)</option>
                                    <option value="reit">Real Estate (P/FFO)</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-emerald-700 hover:bg-emerald-600 text-white font-bold py-2.5 rounded-sm shadow-lg shadow-emerald-900/20 transition-all mt-4 text-xs tracking-wider">
                            CALCULATE INTRINSIC VALUE
                        </button>
                    </form>
                </div>
            </div>

            <!-- RIGHT COLUMN: Valuation Results -->
            <div class="lg:col-span-7 space-y-6">
                <div id="placeholderState" class="h-full flex flex-col items-center justify-center pro-panel p-10 text-center opacity-40 min-h-[500px]">
                    <div class="text-5xl mb-4 grayscale">üìä</div>
                    <h3 class="text-lg font-bold text-white mb-2">Awaiting Data</h3>
                    <p class="text-xs text-gray-500 font-mono">Use Smart Extract or enter data manually<br>to generate valuation model.</p>
                </div>

                <div id="resultsContainer" class="hidden space-y-4">
                    <!-- Executive Verdict -->
                    <div class="pro-panel p-6 border-l-4 border-gray-600 relative" id="verdictPanel">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <!-- Result Logo Placeholder -->
                                <span id="resLogo" class="mr-3"></span>
                                <div>
                                    <h2 class="text-3xl font-bold text-white mb-1 tracking-tight" id="resTicker">TICKER</h2>
                                    <p class="text-gray-500 text-xs uppercase tracking-wider font-mono">Equity Research Report</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold mb-1" id="resVerdict">--</div>
                                <div class="text-[10px] font-mono bg-[#262626] text-gray-300 px-2 py-1 rounded inline-block" id="resMargin">MOS: --%</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-[#262626]">
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Current Price</p>
                                <p class="text-lg font-mono text-white" id="resPrice">$0.00</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Intrinsic Value</p>
                                <p class="text-lg font-mono text-blue-400 font-bold" id="resIntrinsic">$0.00</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Cost of Equity</p>
                                <p class="text-lg font-mono text-white" id="resWacc">0.0%</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Market Cap</p>
                                <p class="text-sm font-mono text-white mt-1" id="resMktCap">$0B</p>
                            </div>
                        </div>
                        
                        <!-- Watchlist Integration Button -->
                        <div class="mt-4 pt-4 border-t border-[#262626] flex justify-end">
                            <button onclick="addValuationToWatchlist()" class="text-[10px] bg-[#262626] hover:bg-[#333] text-gray-300 border border-[#444] px-3 py-1.5 rounded-sm transition-colors flex items-center gap-2 uppercase font-bold tracking-wide">
                                <span>‚≠ê</span> Add to Watchlist
                            </button>
                        </div>
                    </div>

                    <!-- Sensitivity Analysis -->
                    <div class="pro-panel p-5">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest">Sensitivity Analysis</h3>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="p-3 bg-red-900/10 border border-red-900/30 rounded-sm hover:bg-red-900/20 transition-colors">
                                <p class="text-[10px] text-red-400 uppercase font-bold mb-1">Bear Case</p>
                                <p class="text-[9px] text-gray-500 mb-2">Growth -2% / CoE +1%</p>
                                <p class="text-lg font-mono font-bold text-red-400" id="valBear">$0.00</p>
                            </div>
                            <div class="p-3 bg-[#262626] border border-gray-600 rounded-sm relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-0.5 bg-blue-500"></div>
                                <p class="text-[10px] text-white uppercase font-bold mb-1">Base Case</p>
                                <p class="text-[9px] text-gray-500 mb-2">Current Inputs</p>
                                <p class="text-lg font-mono font-bold text-white" id="valBase">$0.00</p>
                            </div>
                            <div class="p-3 bg-green-900/10 border border-green-900/30 rounded-sm hover:bg-green-900/20 transition-colors">
                                <p class="text-[10px] text-green-400 uppercase font-bold mb-1">Bull Case</p>
                                <p class="text-[9px] text-gray-500 mb-2">Growth +2% / CoE -1%</p>
                                <p class="text-lg font-mono font-bold text-green-400" id="valBull">$0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Breakdown -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Market Expectations -->
                        <div class="pro-panel p-5">
                            <h3 class="text-yellow-600 font-bold uppercase text-[10px] tracking-widest mb-3">Reverse DCF (Implied Growth)</h3>
                            <div class="bg-black p-4 rounded border border-[#262626] flex flex-col justify-center h-[100px]">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-500 text-[10px] uppercase">Priced-in Growth</span>
                                    <span class="text-xl font-mono font-bold text-white" id="impliedGrowth">0.0%</span>
                                </div>
                                <div class="w-full bg-[#262626] h-1.5 rounded-full overflow-hidden mb-2 relative">
                                    <div id="impliedMarker" class="absolute top-0 bottom-0 w-1 bg-white" style="left: 0%"></div>
                                    <div class="w-full h-full bg-gradient-to-r from-green-900 via-[#262626] to-red-900"></div>
                                </div>
                                <p class="text-[10px] text-gray-500 text-right font-mono" id="impliedSentiment">Status: Reality</p>
                            </div>
                        </div>

                        <!-- Financial Health -->
                        <div class="pro-panel p-5">
                            <h3 class="text-blue-500 font-bold uppercase text-[10px] tracking-widest mb-3">Financial Position</h3>
                            <div class="space-y-3">
                                <div class="bg-black p-2 rounded border border-[#262626]">
                                    <div class="flex justify-between text-[10px] mb-1">
                                        <span class="text-gray-500 uppercase">Balance Sheet</span>
                                        <span id="debtStatus" class="font-mono">Analyzing...</span>
                                    </div>
                                    <div class="flex items-center gap-1 h-2 w-full bg-[#262626] overflow-hidden">
                                        <div id="barCash" class="bg-green-600 h-full" style="width: 50%"></div>
                                        <div id="barDebt" class="bg-red-600 h-full" style="width: 50%"></div>
                                    </div>
                                    <div class="flex justify-between text-[9px] mt-1 text-gray-500 font-mono">
                                        <span>Cash: <span id="valCash" class="text-green-500">$0B</span></span>
                                        <span>Debt: <span id="valDebt" class="text-red-500">$0B</span></span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center px-1 border-b border-[#262626] pb-1">
                                    <span class="text-[10px] text-gray-500 uppercase">Net Income</span>
                                    <span class="text-sm font-mono text-white font-bold" id="valNi">$0B</span>
                                </div>
                                <div class="flex justify-between items-center px-1">
                                    <span class="text-[10px] text-gray-500 uppercase">FCF</span>
                                    <span class="text-sm font-mono text-blue-400 font-bold" id="valFcf">$0B</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOOL 2: PORTFOLIO TRACKER -->
        <div id="view-portfolio" class="tool-view hidden max-w-6xl mx-auto">
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Add Position Form -->
                <div class="lg:col-span-4">
                    <div class="pro-panel p-6">
                        <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleForm('portfolioFormWrapper')">
                            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-blue-600 rounded-sm"></span>
                                New Trade
                            </h2>
                            <span id="portfolioFormIcon" class="text-blue-500 text-lg font-bold">+</span>
                        </div>
                        <div id="portfolioFormWrapper" class="hidden transition-all duration-300 overflow-hidden">
                            <form id="portfolioForm" onsubmit="event.preventDefault(); addPosition();" class="space-y-4 pt-2">
                                <div class="input-group relative">
                                    <label>Ticker</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="pf_ticker" placeholder="e.g. AAPL" class="uppercase font-bold" required>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>Sector</label>
                                    <select id="pf_sector" required>
                                        <option value="Technology">Technology</option>
                                        <option value="Financials">Financials</option>
                                        <option value="Healthcare">Healthcare</option>
                                        <option value="Consumer">Consumer</option>
                                        <option value="Energy">Energy</option>
                                        <option value="Industrial">Industrial</option>
                                        <option value="Real Estate">Real Estate</option>
                                        <option value="Utilities">Utilities</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>Shares</label>
                                    <input type="number" step="0.001" id="pf_shares" placeholder="0" required>
                                </div>
                                <div class="input-group">
                                    <label>Buy Price ($)</label>
                                    <input type="number" step="0.01" id="pf_price" placeholder="0.00" required>
                                </div>
                                <!-- Hidden logo input -->
                                <input type="hidden" id="pf_logo">
                                <button type="submit" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2.5 rounded-sm shadow-lg shadow-blue-900/20 transition-all text-xs tracking-widest">
                                    ADD POSITION
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Portfolio Summary -->
                    <div class="pro-panel p-6 mt-6 bg-[#111]">
                        <h3 class="text-[10px] text-gray-500 uppercase font-bold mb-4 tracking-widest">Net Liquidation Value</h3>
                        <p class="text-3xl font-mono font-bold text-white mb-1" id="totalValue">$0.00</p>
                        <div class="flex items-center gap-2 border-t border-[#262626] pt-2 mt-2" id="totalPnLContainer">
                            <span class="text-xs font-mono text-gray-400" id="totalPnL">Total PnL: $0.00 (0.00%)</span>
                        </div>
                    </div>
                </div>

                <!-- Positions & Charts -->
                <div class="lg:col-span-8 space-y-6 flex flex-col">
                    
                    <!-- Positions Table (First) -->
                    <div class="pro-panel p-0 min-h-[300px] overflow-hidden">
                        <div class="flex justify-between items-center p-4 border-b border-[#262626] bg-[#111]">
                            <h2 class="text-sm font-bold text-white uppercase tracking-wider">Open Positions</h2>
                            <button onclick="updatePricesViaFinnhub()" id="btnUpdatePrices" class="text-[10px] bg-[#262626] hover:bg-[#333] text-gray-300 border border-[#333] px-3 py-1.5 rounded-sm flex items-center gap-2 transition-colors font-bold">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                REFRESH QUOTES
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left">
                                <thead class="text-[10px] text-gray-500 uppercase bg-[#0f0f0f] border-b border-[#262626]">
                                    <tr>
                                        <th class="px-4 py-3">Ticker</th>
                                        <th class="px-4 py-3">Sector</th>
                                        <th class="px-4 py-3 text-right">Avg Cost</th>
                                        <th class="px-4 py-3 text-right">Qty</th>
                                        <th class="px-4 py-3 text-right w-24">Last Price</th>
                                        <th class="px-4 py-3 text-right">Mkt Value</th>
                                        <th class="px-4 py-3 text-right">Unrealized P/L</th>
                                        <th class="px-4 py-3 text-center"></th>
                                    </tr>
                                </thead>
                                <tbody id="portfolioTableBody" class="text-gray-300 font-mono">
                                    <!-- Rows injected here -->
                                </tbody>
                            </table>
                            <div id="emptyPortfolio" class="text-center py-10 text-gray-600 hidden text-xs font-sans">
                                No open positions.
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Charts (Second) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="pro-panel p-4 flex flex-col justify-center items-center">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest w-full text-left">Exposure by Asset</h3>
                            <!-- Increased Height for Bigger Pie -->
                            <div class="h-80 relative w-full"><canvas id="chartCompany"></canvas></div>
                        </div>
                        <div class="pro-panel p-4 flex flex-col justify-center items-center">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest w-full text-left">Exposure by Sector</h3>
                             <!-- Decreased Height for Smaller Pie -->
                            <div class="h-48 relative w-full"><canvas id="chartSector"></canvas></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- TOOL 3: WATCHLIST -->
        <div id="view-watchlist" class="tool-view hidden max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Watchlist Input -->
                <div class="lg:col-span-4">
                    <div class="pro-panel p-6">
                        <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleForm('watchlistFormWrapper')">
                             <h2 class="text-lg font-bold text-white flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-yellow-600 rounded-sm"></span>
                                Track Stock
                            </h2>
                            <span id="watchlistFormIcon" class="text-yellow-600 text-lg font-bold">+</span>
                        </div>
                        
                        <div id="watchlistFormWrapper" class="hidden transition-all duration-300 overflow-hidden">
                            <form id="watchlistForm" onsubmit="event.preventDefault(); addToWatchlistManual();" class="space-y-4 pt-2">
                                <div class="input-group">
                                    <label>Ticker</label>
                                    <input type="text" id="wl_ticker" placeholder="e.g. MSFT" class="uppercase font-bold" required>
                                </div>
                                <div class="input-group">
                                    <label>Target Buy Price</label>
                                    <input type="number" step="0.01" id="wl_target" placeholder="0.00" required>
                                </div>
                                <div class="input-group">
                                    <label>Current Price</label>
                                    <input type="number" step="0.01" id="wl_price" placeholder="0.00">
                                </div>
                                <!-- Hidden logo input for watchlist -->
                                <input type="hidden" id="wl_logo">
                                <button type="submit" class="w-full bg-[#262626] hover:bg-[#333] border border-yellow-700/30 text-yellow-500 font-bold py-2.5 rounded-sm transition-all text-xs tracking-widest">
                                    ADD TO WATCHLIST
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Watchlist Table -->
                <div class="lg:col-span-8">
                    <div class="pro-panel p-0 min-h-[400px] overflow-hidden">
                        <div class="flex justify-between items-center p-4 border-b border-[#262626] bg-[#111]">
                            <h2 class="text-sm font-bold text-white uppercase tracking-wider">Price Targets</h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left">
                                <thead class="text-[10px] text-gray-500 uppercase bg-[#0f0f0f] border-b border-[#262626]">
                                    <tr>
                                        <th class="px-4 py-3">Ticker</th>
                                        <th class="px-4 py-3 text-right">Target (Range)</th>
                                        <th class="px-4 py-3 text-right w-24">Last Price</th>
                                        <th class="px-4 py-3 text-right">Margin of Safety</th>
                                        <th class="px-4 py-3 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="watchlistTableBody" class="text-gray-300 font-mono">
                                    <!-- Rows injected here -->
                                </tbody>
                            </table>
                            <div id="emptyWatchlist" class="text-center py-10 text-gray-600 hidden text-xs font-sans">
                                Watchlist is empty.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOOL 4: COMPOUND CALCULATOR -->
        <div id="view-compound" class="tool-view hidden max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Inputs -->
                <div class="lg:col-span-4">
                    <div class="pro-panel p-6">
                        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-purple-500 rounded-sm"></span>
                            Parameters
                        </h2>
                        <div class="space-y-4">
                            <div class="input-group">
                                <label>Initial Principal</label>
                                <input type="text" id="comp_principal" value="10000" oninput="updateCompoundCalc()">
                            </div>
                            <div class="input-group">
                                <label>Monthly Contribution</label>
                                <input type="text" id="comp_monthly" value="500" oninput="updateCompoundCalc()">
                            </div>
                            <div class="input-group">
                                <label>Annual Return (%)</label>
                                <input type="text" id="comp_rate" value="8" oninput="updateCompoundCalc()">
                            </div>
                            <div class="input-group">
                                <label>Time Horizon (Years): <span id="comp_years_disp" class="text-blue-500">20</span></label>
                                <input type="range" id="comp_years" min="1" max="50" value="20" class="mt-2" oninput="updateCompoundCalc()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Result Card -->
                    <div class="pro-panel p-6 mt-6 bg-[#111] border-purple-900/30 border">
                        <h3 class="text-[10px] text-gray-500 uppercase font-bold mb-4 tracking-widest">Projected Portfolio Value</h3>
                        <p class="text-3xl font-mono font-bold text-white mb-2" id="comp_final_val">$0.00</p>
                        <div class="text-xs space-y-1">
                            <div class="flex justify-between text-gray-400">
                                <span>Total Invested:</span>
                                <span class="font-mono text-white" id="comp_total_inv">$0.00</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Total Interest:</span>
                                <span class="font-mono text-green-400" id="comp_total_int">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart & Table -->
                <div class="lg:col-span-8 space-y-6">
                    <div class="pro-panel p-4 h-[350px]">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest">Growth Trajectory</h3>
                        <div class="h-[280px] relative w-full">
                            <canvas id="chartCompound"></canvas>
                        </div>
                    </div>
                    
                    <!-- Breakdown Table -->
                    <div class="pro-panel p-0 max-h-[300px] overflow-y-auto">
                         <table class="w-full text-xs text-left">
                            <thead class="text-[10px] text-gray-500 uppercase bg-[#0f0f0f] border-b border-[#262626] sticky top-0">
                                <tr>
                                    <th class="px-4 py-3">Year</th>
                                    <th class="px-4 py-3 text-right">Invested</th>
                                    <th class="px-4 py-3 text-right">Interest</th>
                                    <th class="px-4 py-3 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody id="compoundTableBody" class="text-gray-300 font-mono">
                                <!-- Rows injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Configuration ---
        // Load config from environment or use default
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBusf22EUIeFzxwifZbfd4tMfvOOcr7AiU",¬†
            authDomain: "road-to-a-millie.firebaseapp.com",
            projectId: "road-to-a-millie",
            storageBucket: "road-to-a-millie.firebasestorage.app",
            messagingSenderId: "1089973884329",
            appId: "1:1089973884329:web:704b79247df4c1392b60b8",
            measurementId: "G-..."
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const FINNHUB_KEY = "d5ue01pr01qr4f88rqigd5ue01pr01qr4f88rqj0"; // User provided key
        let currentUser = null;

        // --- Helper Function: Parse Input with Comma Support ---
        function parseInput(id) {
            let val = document.getElementById(id).value;
            // Handle European format: replace comma with dot
            val = val.replace(/,/g, '.');
            return parseFloat(val) || 0;
        }
        
        // --- Helper Function: Toggle Collapsible Forms ---
        function toggleForm(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById(id.replace('Wrapper', 'Icon'));
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                gsap.fromTo(el, {height: 0, opacity: 0}, {height: 'auto', opacity: 1, duration: 0.3});
                if(icon) icon.innerText = '-';
            } else {
                gsap.to(el, {height: 0, opacity: 0, duration: 0.3, onComplete: () => {
                    el.classList.add('hidden');
                    // Reset inline styles from gsap to allow re-opening properly
                    el.style.height = ''; 
                    el.style.opacity = '';
                }});
                if(icon) icon.innerText = '+';
            }
        }

        // --- Auth & Cloud Logic ---
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            const authSection = document.getElementById('auth-section');
            if (user) {
                // Logged In
                authSection.innerHTML = `
                    <span class="text-xs text-millie-green font-mono mr-2">${user.email}</span>
                    <button onclick="handleLogout()" class="text-xs font-bold bg-millie-card text-millie-muted border border-millie-border px-3 py-1.5 rounded-sm hover:text-white transition-colors">LOG OUT</button>
                `;
                document.getElementById('authModal').classList.add('hidden');
                loadFromCloud();
            } else {
                // Logged Out
                authSection.innerHTML = `
                    <button onclick="document.getElementById('authModal').classList.remove('hidden')" class="text-xs font-bold bg-blue-900/30 text-blue-400 border border-blue-800 px-3 py-1.5 rounded-sm hover:bg-blue-800/50 transition-colors">
                        LOGIN / SIGN UP
                    </button>
                `;
                loadFromLocal();
            }
        });

        function handleSignUp() {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            auth.createUserWithEmailAndPassword(email, pass).catch(e => alert(e.message));
        }

        function handleLogin() {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
        }

        function handleLogout() {
            auth.signOut();
            showToast("Logged Out");
        }

        // --- Persistence Logic ---
        const getDataRef = () => db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('financials').doc('data');

        function saveToCloud() {
            if (!currentUser) return;
            
            getDataRef().set({
                portfolio: portfolio,
                watchlist: watchlist,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).then(() => {
                showToast("Synced to Cloud");
            }).catch(e => console.error("Cloud Save Error", e));
        }

        function loadFromCloud() {
            if (!currentUser) return;
            
            getDataRef().get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.portfolio) {
                        portfolio = data.portfolio;
                        localStorage.setItem('millie_portfolio', JSON.stringify(portfolio));
                    }
                    if (data.watchlist) {
                        watchlist = data.watchlist;
                        localStorage.setItem('millie_watchlist', JSON.stringify(watchlist));
                    }
                    refreshUI();
                    showToast("Data Loaded from Cloud");
                }
            }).catch(e => console.error("Cloud Load Error", e));
        }

        function loadFromLocal() {
            portfolio = JSON.parse(localStorage.getItem('millie_portfolio')) || [];
            watchlist = JSON.parse(localStorage.getItem('millie_watchlist')) || [];
            portfolio = portfolio.map(p => ({...p, id: p.id || crypto.randomUUID(), sector: p.sector || 'Other'}));
            watchlist = watchlist.map(w => ({
                 ...w, 
                 id: w.id || crypto.randomUUID(),
                 targetLow: w.targetLow || w.targetPrice * 0.8,
                 targetHigh: w.targetHigh || w.targetPrice * 1.2
            }));
            refreshUI();
        }
        
        function refreshUI() {
            renderPortfolio();
            renderWatchlist();
            if (!document.getElementById('view-portfolio').classList.contains('hidden')) {
                renderCharts();
            }
        }

        // --- Finnhub Data Fetching ---
        async function fetchFinnhubData(ticker) {
            if(!ticker) return null;
            try {
                // 1. Quote
                const quoteRes = await fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${FINNHUB_KEY}`);
                const quoteData = await quoteRes.json();
                
                // 2. Profile
                const profileRes = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${ticker}&token=${FINNHUB_KEY}`);
                const profileData = await profileRes.json();

                return {
                    price: quoteData.c || 0,
                    logo: profileData.logo || '',
                    sector: profileData.finnhubIndustry || 'Other'
                };
            } catch (e) {
                console.error("Finnhub Error:", e);
                // Fail silently for logo, user can still use tool
                return null;
            }
        }
        
        // Handle Ticker change in Valuation model
        async function handleTickerChange(ticker) {
            if(!ticker) return;
            const data = await fetchFinnhubData(ticker.toUpperCase());
            const imgEl = document.getElementById('valLogo');
            if(data && data.logo) {
                imgEl.src = data.logo;
                imgEl.classList.remove('hidden');
            } else {
                imgEl.classList.add('hidden');
            }
        }

        // --- Confirmation Modal Logic ---
        let pendingAction = null;

        function requestDelete(action, id) {
            const modal = document.getElementById('confirmModal');
            const msg = document.getElementById('confirmMessage');
            const btn = document.getElementById('confirmBtn');
            
            if (action === 'position') {
                msg.innerText = "Are you sure you want to close this position? This cannot be undone.";
                document.getElementById('confirmBtn').onclick = function() { deletePosition(id); closeConfirm(); };
            } else if (action === 'watchlist') {
                msg.innerText = "Remove this stock from your watchlist?";
                document.getElementById('confirmBtn').onclick = function() { deleteWatchlistItem(id); closeConfirm(); };
            }
            
            modal.classList.remove('hidden');
        }

        function closeConfirm() {
            document.getElementById('confirmModal').classList.add('hidden');
        }

        // --- 1. Navigation & State ---
        function switchTool(toolName) {
            document.querySelectorAll('.tool-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`view-${toolName}`).classList.remove('hidden');
            document.getElementById(`nav-${toolName}`).classList.add('active');
            
            if(toolName === 'portfolio') {
                renderPortfolio();
                setTimeout(renderCharts, 100);
            }
            if(toolName === 'watchlist') renderWatchlist();
            if(toolName === 'compound') {
                if(!chartCompoundInstance) updateCompoundCalc();
            }
        }

        function setMode(mode) {
            const smart = document.getElementById('smartSection');
            const btnSmart = document.getElementById('btnSmart');
            const btnManual = document.getElementById('btnManual');

            if(mode === 'smart') {
                smart.classList.remove('hidden');
                btnSmart.className = "flex-1 text-xs font-bold text-blue-500 border-b-2 border-blue-500 pb-2";
                btnManual.className = "flex-1 text-xs font-bold text-gray-500 pb-2 hover:text-white transition-colors";
            } else {
                smart.classList.add('hidden');
                btnManual.className = "flex-1 text-xs font-bold text-blue-500 border-b-2 border-blue-500 pb-2";
                btnSmart.className = "flex-1 text-xs font-bold text-gray-500 pb-2 hover:text-white transition-colors";
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- 2. Portfolio Logic ---
        let portfolio = []; 
        
        // --- 3. Watchlist Logic ---
        let watchlist = [];

        function addToWatchlist(ticker, target, current, low, high, logo = '') {
            const exists = watchlist.find(w => w.ticker === ticker);
            if (exists) {
                exists.targetPrice = parseFloat(target);
                exists.targetLow = parseFloat(low);
                exists.targetHigh = parseFloat(high);
                exists.currentPrice = parseFloat(current);
                if(logo) exists.logo = logo;
            } else {
                watchlist.push({
                    id: crypto.randomUUID(),
                    ticker: ticker,
                    targetPrice: parseFloat(target),
                    targetLow: parseFloat(low),
                    targetHigh: parseFloat(high),
                    currentPrice: parseFloat(current),
                    logo: logo
                });
            }
            saveWatchlist();
            renderWatchlist();
            showToast(`Tracking ${ticker}`);
        }

        async function addToWatchlistManual() {
            const ticker = document.getElementById('wl_ticker').value.toUpperCase();
            const target = parseInput('wl_target');
            const current = parseInput('wl_price') || 0;
            
            if(!ticker || !target) return;

            // Fetch Logo
            const data = await fetchFinnhubData(ticker);
            const logo = data ? data.logo : '';

            // Auto generate +/- 20% range for manual entries
            const base = parseFloat(target);
            addToWatchlist(ticker, base, current, base * 0.8, base * 1.2, logo);
            // Close form after adding
            toggleForm('watchlistFormWrapper');
            document.getElementById('watchlistForm').reset();
        }

        function addValuationToWatchlist() {
            const ticker = document.getElementById('smartTicker').value.toUpperCase() || document.getElementById('resTicker').innerText;
            const intrinsicStr = document.getElementById('resIntrinsic').innerText.replace(/[^0-9.-]+/g,"");
            const currentStr = document.getElementById('resPrice').innerText.replace(/[^0-9.-]+/g,"");
            const lowStr = document.getElementById('valBear').innerText.replace(/[^0-9.-]+/g,"");
            const highStr = document.getElementById('valBull').innerText.replace(/[^0-9.-]+/g,"");
            
            const intrinsic = parseFloat(intrinsicStr);
            const current = parseFloat(currentStr);
            const low = parseFloat(lowStr);
            const high = parseFloat(highStr);
            
            if (!intrinsic || intrinsic === 0) return alert("Calculate a valuation first.");
            
            // Try to get logo from the UI if present, or fetch fresh
            let logo = "";
            const imgEl = document.getElementById('valLogo');
            if(imgEl && !imgEl.classList.contains('hidden')) {
                logo = imgEl.src;
                addToWatchlist(ticker, intrinsic, current, low, high, logo);
            } else {
                fetchFinnhubData(ticker).then(data => {
                    const logo = data ? data.logo : '';
                    addToWatchlist(ticker, intrinsic, current, low, high, logo);
                });
            }
        }

        function deleteWatchlistItem(id) {
            watchlist = watchlist.filter(w => w.id !== id);
            saveWatchlist();
            renderWatchlist();
        }

        function updateWatchlistPrice(id, price) {
            const idx = watchlist.findIndex(w => w.id === id);
            if(idx >= 0) {
                let val = price.replace(/,/g, '.');
                watchlist[idx].currentPrice = parseFloat(val) || 0;
                saveWatchlist();
                renderWatchlist();
            }
        }

        function saveWatchlist() {
            if (currentUser) {
                saveToCloud();
            } else {
                localStorage.setItem('millie_watchlist', JSON.stringify(watchlist));
            }
        }

        function renderWatchlist() {
            const tbody = document.getElementById('watchlistTableBody');
            tbody.innerHTML = '';
            const cur = '$'; 
            
            if(watchlist.length === 0) {
                document.getElementById('emptyWatchlist').classList.remove('hidden');
            } else {
                document.getElementById('emptyWatchlist').classList.add('hidden');
                
                watchlist.forEach((item) => {
                    let mos = 0;
                    if(item.currentPrice > 0) {
                        mos = ((item.targetPrice - item.currentPrice) / item.currentPrice) * 100;
                    }
                    
                    const mosColor = mos > 0 ? 'text-green-400' : 'text-red-400';
                    const mosText = mos > 0 ? `Undervalued (${mos.toFixed(1)}%)` : `Premium (${Math.abs(mos).toFixed(1)}%)`;
                    const rangeDisplay = `${cur}${item.targetLow.toFixed(2)} | <span class="text-blue-400 font-bold">$${item.targetPrice.toFixed(2)}</span> | ${cur}${item.targetHigh.toFixed(2)}`;
                    
                    // Logo handling
                    const logoHtml = item.logo ? `<img src="${item.logo}" class="company-logo">` : '';

                    const row = document.createElement('tr');
                    row.className = "hover:bg-millie-card transition-colors border-b border-millie-border";
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 font-bold text-millie-text font-sans flex items-center">${logoHtml} ${item.ticker}</td>
                        <td class="px-4 py-3 text-right text-millie-muted font-mono text-xs whitespace-nowrap">${rangeDisplay}</td>
                        <td class="px-4 py-3 text-right">
                            <input type="number" step="0.01" value="${item.currentPrice}" 
                                onchange="updateWatchlistPrice('${item.id}', this.value)"
                                class="bg-millie-input border border-millie-border rounded-sm px-1 py-0.5 w-20 text-right text-blue-400 focus:border-millie-accent outline-none font-bold">
                        </td>
                        <td class="px-4 py-3 text-right ${mosColor} font-bold">
                            ${mosText}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="requestDelete('watchlist', '${item.id}')" class="text-millie-muted hover:text-millie-red transition-colors font-bold text-lg">√ó</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // --- 5. Portfolio Functions ---
        async function addPosition() {
            const ticker = document.getElementById('pf_ticker').value.toUpperCase();
            const sector = document.getElementById('pf_sector').value;
            const shares = parseInput('pf_shares');
            const price = parseInput('pf_price');

            if(!ticker || isNaN(shares) || isNaN(price)) return;

            // Fetch logo
            const data = await fetchFinnhubData(ticker);
            const logo = data ? data.logo : '';

            const existingIndex = portfolio.findIndex(p => p.ticker === ticker);

            if(existingIndex >= 0) {
                const oldPos = portfolio[existingIndex];
                const totalCost = (oldPos.shares * oldPos.avgPrice) + (shares * price);
                const totalShares = oldPos.shares + shares;
                
                portfolio[existingIndex].shares = totalShares;
                portfolio[existingIndex].avgPrice = totalCost / totalShares;
                portfolio[existingIndex].sector = sector; 
                if(logo) portfolio[existingIndex].logo = logo; // Update logo if newer
            } else {
                portfolio.push({ 
                    id: crypto.randomUUID(),
                    ticker, 
                    sector, 
                    shares, 
                    avgPrice: price, 
                    currentPrice: price,
                    logo: logo
                });
            }

            savePortfolio();
            document.getElementById('portfolioForm').reset();
            // Clear hidden logo
            document.getElementById('pf_logo').value = "";
            toggleForm('portfolioFormWrapper'); // Close form
            renderPortfolio();
            renderCharts();
        }

        function deletePosition(id) {
            portfolio = portfolio.filter(p => p.id !== id);
            savePortfolio();
            renderPortfolio();
            renderCharts();
        }

        function updateCurrentPrice(id, newPrice) {
            const idx = portfolio.findIndex(p => p.id === id);
            if(idx >= 0) {
                let val = newPrice.replace(/,/g, '.');
                portfolio[idx].currentPrice = parseFloat(val) || 0;
                savePortfolio();
                renderPortfolio();
                renderCharts();
            }
        }

        async function updatePricesViaFinnhub() {
            const btn = document.getElementById('btnUpdatePrices');
            const originalText = btn.innerHTML;
            btn.innerHTML = `Updating...`;
            btn.disabled = true;

            for (let p of portfolio) {
                const data = await fetchFinnhubData(p.ticker);
                if (data && data.price) {
                    p.currentPrice = data.price;
                }
            }
            
            savePortfolio();
            renderPortfolio();
            renderCharts();
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function savePortfolio() {
            if (currentUser) {
                saveToCloud();
            } else {
                localStorage.setItem('millie_portfolio', JSON.stringify(portfolio));
            }
        }

        // --- 6. Charts Logic ---
        let chartCompany = null;
        let chartSector = null;

        function renderCharts() {
            if(portfolio.length === 0) return;

            const companyData = portfolio.map(p => p.shares * p.currentPrice);
            const companyLabels = portfolio.map(p => p.ticker);
            const totalValue = companyData.reduce((a, b) => a + b, 0);
            const cur = '$';
            
            const sectorMap = {};
            let totalCost = 0;
            portfolio.forEach(p => {
                const val = p.shares * p.currentPrice;
                const cost = p.shares * p.avgPrice;
                sectorMap[p.sector] = (sectorMap[p.sector] || 0) + val;
                totalCost += cost;
            });
            
            const totalPnL = totalValue - totalCost;
            const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;
            const pnlSign = totalPnL >= 0 ? '+' : '';
            const pnlColorHex = totalPnL >= 0 ? '#10b981' : '#ef4444'; // green : red

            // Plugin definition for floating labels with logo and percentage
            const floatingLabels = {
                id: 'floatingLabels',
                afterDraw(chart, args, options) {
                    const { ctx } = chart;
                    const meta = chart.getDatasetMeta(0);
                    const { width, height, top, left } = chart.chartArea;
                    const centerX = left + width / 2;
                    const centerY = top + height / 2;
                    
                    // Pre-load images
                    const logoImages = portfolio.map(p => {
                        const img = new Image();
                        if(p.logo) img.src = p.logo;
                        return img;
                    });
                    
                    meta.data.forEach((arc, index) => {
                        const { startAngle, endAngle, outerRadius } = arc;
                        const midAngle = startAngle + (endAngle - startAngle) / 2;
                        
                        const val = companyData[index];
                        const percentage = totalValue > 0 ? Math.round((val / totalValue) * 100) : 0;
                        
                        if (percentage < 3) return; // Skip small slices

                        const offset = 20;
                        const x = centerX + Math.cos(midAngle) * (outerRadius + offset);
                        const y = centerY + Math.sin(midAngle) * (outerRadius + offset);
                        
                        const pillW = 50;
                        const pillH = 24;
                        const r = 12;
                        const px = x - pillW / 2;
                        const py = y - pillH / 2;

                        ctx.save();
                        ctx.fillStyle = '#171717'; 
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 1;
                        
                        ctx.beginPath();
                        if(ctx.roundRect) ctx.roundRect(px, py, pillW, pillH, r);
                        else ctx.rect(px, py, pillW, pillH);
                        ctx.fill();
                        ctx.stroke();

                        const img = logoImages[index];
                        // If image is loaded, draw it
                        if (img && img.src && img.complete && img.naturalWidth !== 0) {
                            ctx.save();
                            ctx.beginPath();
                            ctx.arc(px + 12, py + 12, 8, 0, 2 * Math.PI);
                            ctx.clip();
                            ctx.fillStyle = 'white';
                            ctx.fill();
                            ctx.drawImage(img, px + 4, py + 4, 16, 16);
                            ctx.restore();
                        } else {
                            // Fallback if logo not loaded yet: Force redraw or just show circle
                            // For simplicity, just a placeholder circle, 
                            // but in real app we might want to force update once images load.
                            // We trigger chart update in addPosition so usually it loads fast.
                            ctx.beginPath();
                            ctx.arc(px + 12, py + 12, 8, 0, 2 * Math.PI);
                            ctx.fillStyle = '#333';
                            ctx.fill();
                        }

                        ctx.fillStyle = '#fff';
                        ctx.font = 'bold 10px Inter, sans-serif';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(percentage + '%', px + 24, py + 12);
                        
                        ctx.restore();
                    });
                    
                    // Draw Center Total PnL
                    ctx.save();
                    ctx.font = 'bold 16px Inter, sans-serif';
                    ctx.fillStyle = pnlColorHex;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${pnlSign}${totalPnLPct.toFixed(1)}%`, centerX, centerY);
                    
                    ctx.font = '10px Inter, sans-serif';
                    ctx.fillStyle = '#a3a3a3';
                    ctx.fillText('Total Return', centerX, centerY + 14);
                    ctx.restore();
                }
            };
            
            const percentageTooltip = {
                 callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        let value = context.raw || 0;
                        let percentage = totalValue > 0 ? Math.round((value / totalValue) * 100) : 0;
                        return `${label}: ${cur}${value.toLocaleString()} (${percentage}%)`;
                    }
                },
                backgroundColor: 'rgba(23, 23, 23, 0.9)',
                titleColor: '#fff',
                bodyColor: '#ccc',
                borderColor: '#333',
                borderWidth: 1,
                padding: 10,
                cornerRadius: 4
            };

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#a3a3a3', font: {size: 10, family: 'Inter'} }, boxWidth: 10 },
                    tooltip: percentageTooltip
                },
                layout: { padding: 0 }
            };

            const ctxComp = document.getElementById('chartCompany').getContext('2d');
            if(chartCompany) chartCompany.destroy();
            
            chartCompany = new Chart(ctxComp, {
                type: 'doughnut',
                data: {
                    labels: companyLabels,
                    datasets: [{
                        data: companyData,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    ...commonOptions,
                    layout: { padding: 40 }, 
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { display: false }, 
                    }
                },
                plugins: [floatingLabels] 
            });

            const ctxSec = document.getElementById('chartSector').getContext('2d');
            if(chartSector) chartSector.destroy();
            chartSector = new Chart(ctxSec, {
                type: 'pie',
                data: {
                    labels: Object.keys(sectorMap),
                    datasets: [{
                        data: Object.values(sectorMap),
                        backgroundColor: ['#2563eb', '#0d9488', '#ea580c', '#65a30d', '#9333ea'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: commonOptions // No custom labels for sector chart yet
            });
        }

        function renderPortfolio() {
            const tbody = document.getElementById('portfolioTableBody');
            tbody.innerHTML = '';
            const cur = '$';
            
            let totalVal = 0;
            let totalCost = 0;

            if(portfolio.length === 0) {
                document.getElementById('emptyPortfolio').classList.remove('hidden');
            } else {
                document.getElementById('emptyPortfolio').classList.add('hidden');
                
                portfolio.forEach((pos, index) => {
                    const marketVal = pos.shares * pos.currentPrice;
                    const costBasis = pos.shares * pos.avgPrice;
                    const pnl = marketVal - costBasis;
                    const pnlPct = costBasis > 0 ? (pnl / costBasis) * 100 : 0;
                    
                    totalVal += marketVal;
                    totalCost += costBasis;

                    const row = document.createElement('tr');
                    row.className = "border-b border-millie-border hover:bg-millie-card transition-colors";
                    
                    const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                    const pnlSign = pnl >= 0 ? '+' : '';
                    
                    // Add logo if exists
                    const logoHtml = pos.logo ? `<img src="${pos.logo}" class="company-logo">` : '';

                    row.innerHTML = `
                        <td class="px-4 py-3 font-bold text-millie-text font-sans flex items-center">${logoHtml} ${pos.ticker}</td>
                        <td class="px-4 py-3 text-xs text-millie-muted font-sans">${pos.sector}</td>
                        <td class="px-4 py-3 text-right text-millie-muted">${cur}${pos.avgPrice.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right text-millie-muted">${pos.shares}</td>
                        <td class="px-4 py-3 text-right">
                            <input type="number" step="0.01" value="${pos.currentPrice}" 
                                onchange="updateCurrentPrice('${pos.id}', this.value)"
                                class="bg-millie-input border border-millie-border rounded-sm px-1 py-0.5 w-20 text-right text-blue-400 focus:border-millie-accent outline-none font-bold">
                        </td>
                        <td class="px-4 py-3 text-right font-bold text-millie-text">${cur}${marketVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-4 py-3 text-right font-bold ${pnlColor}">
                            <div>${pnlSign}${cur}${pnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="text-[10px] opacity-70">${pnlSign}${pnlPct.toFixed(2)}%</div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="requestDelete('position', '${pos.id}')" class="text-millie-muted hover:text-millie-red transition-colors font-bold text-lg">√ó</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            const totalPnL = totalVal - totalCost;
            const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;
            const totalSign = totalPnL >= 0 ? '+' : '';
            const totalColor = totalPnL >= 0 ? 'text-green-400' : 'text-red-400';

            document.getElementById('totalValue').innerText = `${cur}${totalVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalPnL').innerHTML = `<span class="${totalColor}">${totalSign}${cur}${totalPnL.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${totalSign}${totalPnLPct.toFixed(2)}%)</span>`;
        }

        // --- 7. Compound Calculator Logic ---
        let chartCompoundInstance = null;

        function updateCompoundCalc() {
            const P = parseInput('comp_principal');
            const PMT = parseInput('comp_monthly');
            const r = parseInput('comp_rate') / 100;
            const years = parseInt(document.getElementById('comp_years').value);
            const cur = '$';
            
            document.getElementById('comp_years_disp').innerText = years;
            
            const n = 12; // Monthly
            let dataInvested = [];
            let dataBalance = [];
            let labels = [];
            let yearlyBreakdown = [];
            
            let currentBalance = P;
            let currentInvested = P;
            
            for(let i = 0; i <= years; i++) {
                labels.push(`Year ${i}`);
                dataInvested.push(currentInvested);
                dataBalance.push(currentBalance);
                
                // Store breakdown for table
                if (i > 0) {
                     yearlyBreakdown.push({
                         year: i,
                         invested: currentInvested,
                         interest: currentBalance - currentInvested,
                         total: currentBalance
                     });
                }

                // Advance one year (12 months)
                if (i < years) {
                    for(let m=0; m<12; m++) {
                        currentBalance = (currentBalance + PMT) * (1 + r/n);
                        currentInvested += PMT;
                    }
                }
            }

            // Update Headline Numbers
            document.getElementById('comp_final_val').innerText = `${cur}${currentBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('comp_total_inv').innerText = `${cur}${currentInvested.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('comp_total_int').innerText = `${cur}${(currentBalance - currentInvested).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            // Update Table
            const tbody = document.getElementById('compoundTableBody');
            tbody.innerHTML = '';
            // Show every 5th year + final year to save space, or all if short duration
            yearlyBreakdown.forEach(row => {
                if (row.year === 1 || row.year % 5 === 0 || row.year === years) {
                     const tr = document.createElement('tr');
                     tr.className = "border-b border-millie-border hover:bg-millie-bg transition-colors";
                     tr.innerHTML = `
                        <td class="px-4 py-2 font-bold text-millie-text">${row.year}</td>
                        <td class="px-4 py-2 text-right text-millie-muted">${cur}${row.invested.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                        <td class="px-4 py-2 text-right text-millie-green">+${cur}${row.interest.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                        <td class="px-4 py-2 text-right font-bold text-millie-text">${cur}${row.total.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                     `;
                     tbody.appendChild(tr);
                }
            });

            // Update Chart
            const ctx = document.getElementById('chartCompound').getContext('2d');
            if (chartCompoundInstance) chartCompoundInstance.destroy();
            
            chartCompoundInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Portfolio Value',
                            data: dataBalance,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Cash Invested',
                            data: dataInvested,
                            borderColor: '#6b7280',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${cur}${context.raw.toLocaleString(undefined, {maximumFractionDigits:0})}`;
                                }
                             }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#6b7280', callback: function(value) { return cur + (value/1000) + 'k'; } },
                            grid: { color: '#374151' }
                        },
                        x: {
                            ticks: { color: '#6b7280' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }


        // --- 8. Smart Parser Logic (Valuation Tool) ---
        function openDataSource() {
            const ticker = document.getElementById('smartTicker').value;
            if(!ticker) return alert("Enter a ticker first!");
            window.open(`https://finance.yahoo.com/quote/${ticker}/key-statistics/`, '_blank');
        }

        function rollForward() {
            const fcfInput = document.getElementById('fcf_ttm');
            const growthInput = document.getElementById('growth_rate');
            let fcf = parseInput('fcf_ttm');
            let growth = parseInput('growth_rate');
            
            if (fcf === 0 && document.getElementById('fcf_ttm').value === "") return alert("Enter a starting FCF value first.");
            
            const forwardFcf = fcf * (1 + (growth / 100));
            fcfInput.value = forwardFcf.toFixed(2);
            gsap.from(fcfInput, { backgroundColor: "rgba(16, 185, 129, 0.4)", duration: 0.5, clearProps: "backgroundColor" });
        }

        function rollForwardNI() {
            const niInput = document.getElementById('ni_ttm');
            const growthInput = document.getElementById('growth_rate');
            let ni = parseInput('ni_ttm');
            let growth = parseInput('growth_rate');
            
            if (ni === 0 && document.getElementById('ni_ttm').value === "") return alert("Enter a starting Net Income value first.");
            
            const forwardNi = ni * (1 + (growth / 100));
            niInput.value = forwardNi.toFixed(2);
            gsap.from(niInput, { backgroundColor: "rgba(16, 185, 129, 0.4)", duration: 0.5, clearProps: "backgroundColor" });
        }

        function parseAndFill() {
            let text = document.getElementById('pasteArea').value.toLowerCase();
            const lang = document.getElementById('pasteLanguage').value; 
            
            if(!text) return alert("Paste some data first!");

            document.getElementById('extractStatus').classList.remove('hidden');
            text = text.replace(/\s+/g, ' ');

            const labels = {
                en: {
                    shares: ["shares outstanding 5", "shares outstanding", "implied shares outstanding"],
                    beta: ["beta (5y monthly)", "beta (5-year monthly)"],
                    netIncome: ["net income avl to common (ttm)", "net income avl to common", "net income available to common", "net income"],
                    fcf: ["levered free cash flow (ttm)", "levered free cash flow", "free cash flow"],
                    cash: ["total cash (mrq)", "total cash"],
                    debt: ["total debt (mrq)", "total debt"],
                    priceAnchor: "previous close"
                },
                es: {
                    shares: ["acciones en circulaci√≥n 5", "acciones en circulaci√≥n", "acciones en circulacion"],
                    beta: ["beta (5 a", "beta (5y"],
                    netIncome: ["ingresos netos disponibles", "ingreso neto disponible", "ingreso neto"],
                    fcf: ["flujo de efectivo apalancado", "flujo de caja libre", "flujo de efectivo libre"],
                    cash: ["efectivo total", "total de efectivo"],
                    debt: ["endeudamiento total", "deuda total"],
                    priceAnchor: ["cierre anterior", "cierre previo"]
                },
                fr: {
                    shares: ["actions en attente 5", "actions en attente", "actions en circulation", "nombre d'actions"],
                    beta: ["b√™ta (mensuel sur 5 ans)", "b√™ta (mensuel", "b√™ta (5", "beta (mensuel"],
                    netIncome: ["b√©n√©fice net disponible distribuable", "r√©sultat net part du groupe", "b√©n√©fice net"],
                    fcf: ["effet de levier de flux de tr√©sorerie libre", "flux de tr√©sorerie disponible", "free cash flow"],
                    cash: ["tr√©sorerie totale", "disponibilit√©s totales"],
                    debt: ["dette totale"],
                    priceAnchor: "cl√¥ture pr√©c√©dente"
                }
            };

            const currentLabels = labels[lang];

            function extractNumber(labelKeys) {
                const keys = Array.isArray(labelKeys) ? labelKeys : [labelKeys];
                for (let key of keys) {
                    const safeKey = key.replace(/[()]/g, "\\$&"); 
                    const regex = new RegExp(`${safeKey}.{0,60}?([0-9-][0-9.,\\s]*[BTMkMd]*)`, 'i');
                    const match = text.match(regex);
                    if(match && match[1]) {
                        const raw = match[1].trim();
                        if (/[0-9]/.test(raw)) {
                            return parseFinancialString(raw);
                        }
                    }
                }
                return null;
            }

            function extractPrice() {
                const regex = /([0-9.,]+)\s*[+-]?[0-9.,]+\s*\(/;
                const match = text.match(regex);
                if (match && match[1]) {
                    return parseFinancialString(match[1]);
                }
                return extractNumber(currentLabels.priceAnchor) || 0;
            }

            function parseFinancialString(str) {
                str = str.trim().toUpperCase();
                str = str.replace(/\s/g, ''); 
                
                let valStr = str;
                let multiplier = 1;
                
                if(str.includes('T')) { multiplier = 1000; valStr = str.replace('T',''); }
                else if(str.includes('B')) { multiplier = 1; valStr = str.replace('B',''); } 
                else if(str.includes('M') && !str.includes('MD') && !str.includes('MM')) { multiplier = 0.001; valStr = str.replace('M',''); }
                else if(str.includes('MD')) { multiplier = 1; valStr = str.replace('MDS','').replace('MD',''); }
                else if(str.includes('MM')) { multiplier = 1; valStr = str.replace('MM',''); }
                else if(str.includes('K')) { multiplier = 0.000001; valStr = str.replace('K',''); }

                valStr = valStr.replace(/[A-Z]/g, '');

                if (lang === 'en') {
                    valStr = valStr.replace(/,/g, '');
                } else {
                    valStr = valStr.replace(/\./g, '').replace(',', '.');
                }
                
                return parseFloat(valStr) * multiplier;
            }

            try {
                let price = extractPrice();
                if(price) document.getElementById('price').value = price;
                let shares = extractNumber(currentLabels.shares);
                if(shares) document.getElementById('shares').value = shares;
                let beta = extractNumber(currentLabels.beta);
                if(beta) document.getElementById('beta').value = beta;
                let ni = extractNumber(currentLabels.netIncome);
                if(ni) document.getElementById('ni_ttm').value = ni;
                let fcf = extractNumber(currentLabels.fcf);
                if(fcf) document.getElementById('fcf_ttm').value = fcf;
                let cash = extractNumber(currentLabels.cash);
                if(cash) document.getElementById('cash').value = cash;
                let debt = extractNumber(currentLabels.debt);
                if(debt) document.getElementById('debt').value = debt;

                // Also fetch logo for visual consistency
                const ticker = document.getElementById('smartTicker').value;
                if(ticker) handleTickerChange(ticker);

                document.getElementById('dataQualityBadge').innerText = "DATA EXTRACTED";
                document.getElementById('dataQualityBadge').className = "text-[9px] bg-green-400 text-black px-2 py-0.5 rounded border border-green-700";
                document.getElementById('extractStatus').innerText = "Success";
                gsap.from("#calcForm input", { borderColor: "#10b981", duration: 0.5, clearProps: "all" });
            } catch (e) {
                console.error(e);
                alert("Could not parse data. Check language selection.");
                document.getElementById('extractStatus').classList.add('hidden');
            }
        }

        // --- 9. Valuation Logic (Pure Calculation) ---
        function calculateIntrinsicValue(inputs) {
            const { fcf, shares, growthRate, costOfEquity, sector, cash, debt, ni } = inputs;
            let intrinsicVal = 0;
            let exitMultiple = 15;

            if (sector === 'bank') {
                let g = Math.min(growthRate, 0.03); 
                let impliedDividend = ni * 0.50; 
                intrinsicVal = (impliedDividend / shares) / (costOfEquity - g);
            } else if (sector === 'reit') {
                intrinsicVal = (fcf / shares) * 15; 
            } else {
                if (sector === 'tech') exitMultiple = 15;
                if (sector === 'high_tech') exitMultiple = 30;
                if (sector === 'industrial') exitMultiple = 7;
                
                let sumPV = 0;
                let futureFCF = fcf;
                for(let i=1; i<=10; i++) {
                    let g = growthRate - ((growthRate - 0.03) * (i/10));
                    futureFCF = futureFCF * (1 + g);
                    sumPV += futureFCF / Math.pow(1 + costOfEquity, i);
                }
                let termVal = futureFCF * exitMultiple;
                let pvTerm = termVal / Math.pow(1 + costOfEquity, 10);
                
                let equityValue = sumPV + pvTerm + (cash * 0.5); 
                intrinsicVal = equityValue / shares;
            }
            return intrinsicVal;
        }

        function runAnalysis() {
            const price = parseInput('price');
            const shares = parseInput('shares');
            let rawBeta = parseInput('beta');
            if (rawBeta === 0 && document.getElementById('beta').value === "") rawBeta = 1.0;

            const ni = parseInput('ni_ttm');
            const fcf = parseInput('fcf_ttm');
            const cash = parseInput('cash');
            const debt = parseInput('debt');
            const growthRate = parseInput('growth_rate') / 100;
            const sector = document.getElementById('sector').value;
            const rfrInput = parseInput('rfr');
            const rfrVal = (rfrInput === 0 && document.getElementById('rfr').value === "") ? 4.2 : rfrInput;
            const rfr = rfrVal / 100;
            const cur = '$';

            const adjBeta = (0.67 * rawBeta) + (0.33 * 1.0);
            const baseCostOfEquity = rfr + (adjBeta * 0.055); 

            const commonInputs = { fcf, shares, sector, cash, debt, ni };

            // 1. Base
            const intrinsicVal = calculateIntrinsicValue({
                ...commonInputs,
                growthRate: growthRate,
                costOfEquity: baseCostOfEquity
            });

            // 2. Bear
            const bearVal = calculateIntrinsicValue({
                ...commonInputs,
                growthRate: Math.max(0, growthRate - 0.02),
                costOfEquity: baseCostOfEquity + 0.01
            });

            // 3. Bull
            const bullVal = calculateIntrinsicValue({
                ...commonInputs,
                growthRate: growthRate + 0.02,
                costOfEquity: Math.max(0.01, baseCostOfEquity - 0.01)
            });

            const mos = ((intrinsicVal - price) / price) * 100;
            let verdict = "HOLD";
            let verdictColorClass = "text-millie-text";
            let panelBorderClass = "border-millie-muted";
            let mosBgClass = "bg-millie-card text-millie-text";

            if (mos > 15) {
                verdict = "BUY";
                verdictColorClass = "text-millie-green";
                panelBorderClass = "border-millie-green";
                mosBgClass = "bg-green-900/30 text-millie-green border border-green-800";
            } else if (mos < -10) {
                verdict = "SELL";
                verdictColorClass = "text-millie-red";
                panelBorderClass = "border-millie-red";
                mosBgClass = "bg-red-900/30 text-millie-red border border-red-800";
            } else {
                verdict = "HOLD"; 
                verdictColorClass = "text-millie-text"; 
                panelBorderClass = "border-millie-border"; 
                mosBgClass = "bg-millie-card text-millie-muted border border-millie-border";
            }

            let impliedG = 0;
            if (sector !== 'bank' && sector !== 'reit') {
                let low = -0.50;
                let high = 1.00;
                for(let i=0; i<20; i++) { 
                    let mid = (low + high) / 2;
                    let testVal = calculateIntrinsicValue({
                        ...commonInputs,
                        growthRate: mid,
                        costOfEquity: baseCostOfEquity
                    });
                    if (testVal > price) high = mid;
                    else low = mid;
                }
                impliedG = (low + high) / 2;
            }

            document.getElementById('placeholderState').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');

            const ticker = document.getElementById('smartTicker').value || "STOCK";
            // Logo handling for results
            const logoSrc = document.getElementById('valLogo').src;
            const logoDisplay = (logoSrc && !document.getElementById('valLogo').classList.contains('hidden')) 
                ? `<img src="${logoSrc}" class="w-8 h-8 rounded-full mr-3 inline-block bg-white p-0.5" style="vertical-align: bottom;">` 
                : '';

            document.getElementById('resTicker').innerHTML = `${logoDisplay}${ticker.toUpperCase()}`;
            
            const vEl = document.getElementById('resVerdict');
            const pEl = document.getElementById('verdictPanel');
            const mEl = document.getElementById('resMargin');
            
            vEl.innerText = verdict;
            vEl.className = `text-2xl font-bold mb-1 ${verdictColorClass}`;
            pEl.className = `glass-panel p-6 border-l-4 ${panelBorderClass} relative`;
            mEl.innerText = `MOS: ${mos.toFixed(1)}%`;
            mEl.className = `text-[10px] font-mono px-2 py-1 rounded inline-block ${mosBgClass}`;

            document.getElementById('resPrice').innerText = `${cur}${price.toFixed(2)}`;
            document.getElementById('resIntrinsic').innerText = `${cur}${intrinsicVal.toFixed(2)}`;
            document.getElementById('resWacc').innerText = `${(baseCostOfEquity*100).toFixed(1)}%`;
            document.getElementById('resMktCap').innerText = `${cur}${(price*shares).toFixed(1)}B`;

            document.getElementById('valBase').innerText = `${cur}${intrinsicVal.toFixed(2)}`;
            document.getElementById('valBear').innerText = `${cur}${bearVal.toFixed(2)}`;
            document.getElementById('valBull').innerText = `${cur}${bullVal.toFixed(2)}`;

            let impliedPct = (impliedG * 100);
            if (sector === 'bank' || sector === 'reit') impliedPct = 0; 
            
            document.getElementById('impliedGrowth').innerText = `${impliedPct.toFixed(1)}%`;
            let markerPos = ((impliedPct) / 20) * 100;
            if (markerPos < 0) markerPos = 0;
            if (markerPos > 100) markerPos = 100;
            document.getElementById('impliedMarker').style.left = `${markerPos}%`;
            
            let sentiment = "Reality";
            if (impliedPct > 15) sentiment = "High Optimism";
            else if (impliedPct < 2) sentiment = "Pessimism";
            document.getElementById('impliedSentiment').innerText = `Implied: ${sentiment}`;

            document.getElementById('valNi').innerText = `${cur}${ni}B`;
            document.getElementById('valFcf').innerText = `${cur}${fcf}B`;
            document.getElementById('valCash').innerText = `${cur}${cash}B`;
            document.getElementById('valDebt').innerText = `${cur}${debt}B`;
            
            const totalCap = cash + debt + 0.1; 
            document.getElementById('barCash').style.width = `${(cash/totalCap)*100}%`;
            document.getElementById('barDebt').style.width = `${(debt/totalCap)*100}%`;
            
            if(debt > cash * 3) {
                document.getElementById('debtStatus').innerHTML = '<span class="text-millie-red">High Leverage</span>';
            } else if (cash > debt) {
                document.getElementById('debtStatus').innerHTML = '<span class="text-millie-green">Net Cash</span>';
            } else {
                document.getElementById('debtStatus').innerHTML = '<span class="text-yellow-400">Moderate</span>';
            }

            gsap.from("#resultsContainer > div", { y: 20, opacity: 0, stagger: 0.1 });
        }
    </script>
</body>
</html>
