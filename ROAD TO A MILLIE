<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road to a Millie | Pro Terminal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        wallstreet: {
                            bg: '#0a0a0a',       // Deepest Black
                            card: '#171717',     // Dark Grey
                            border: '#262626',   // Subtle Border
                            accent: '#3b82f6',   // Professional Blue
                            green: '#10b981',    // Financial Green
                            red: '#ef4444',      // Financial Red
                            text: '#e5e5e5',     // Off-white
                            muted: '#a3a3a3'     // Muted Text
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0a0a0a;
            color: #e5e5e5;
            overflow-x: hidden;
        }

        /* Professional Card Style */
        .pro-panel {
            background-color: #171717;
            border: 1px solid #262626;
            border-radius: 4px; /* Sharper corners */
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .input-group label {
            display: block;
            font-size: 0.65rem;
            color: #a3a3a3;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            background-color: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 0.5rem;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            transition: border-color 0.2s;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .paste-zone {
            border: 1px dashed #444;
            transition: all 0.2s ease;
        }
        .paste-zone:focus-within {
            border-color: #3b82f6;
            background: #111;
        }

        /* Professional Nav Tabs */
        .nav-btn.active {
            color: #fff;
            background-color: #262626;
            border-bottom: 2px solid #3b82f6;
        }
        .nav-btn {
            color: #737373;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .nav-btn:hover {
            color: #d4d4d4;
            background-color: #1a1a1a;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #10b981;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 12px;
            position: fixed;
            z-index: 100;
            bottom: 30px;
            right: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s;
            font-size: 0.875rem;
            font-weight: 500;
        }
        #toast.show {
            visibility: visible;
            transform: translateY(0);
            opacity: 1;
        }

        /* Table Styling */
        table th {
            font-weight: 600;
            letter-spacing: 0.05em;
            color: #737373;
        }
        table td {
            border-bottom: 1px solid #262626;
        }
        table tr:last-child td {
            border-bottom: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4 relative bg-[#050505]">

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-sm hidden">
        <div class="bg-[#171717] border border-[#333] p-6 rounded-md shadow-2xl max-w-sm w-full">
            <h3 class="text-white font-bold text-lg mb-2">Confirm Deletion</h3>
            <p id="confirmMessage" class="text-gray-400 text-sm mb-6">Are you sure you want to remove this item?</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeConfirm()" class="px-4 py-2 text-sm text-gray-300 hover:text-white transition-colors bg-[#262626] hover:bg-[#333] rounded-sm">Cancel</button>
                <button id="confirmBtn" class="px-4 py-2 text-sm bg-red-700 hover:bg-red-600 text-white rounded-sm transition-colors shadow-lg shadow-red-900/20">Delete</button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="pro-panel p-8 rounded-md max-w-md w-full relative">
            <button onclick="document.getElementById('apiModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold mb-4 text-white">System Configuration</h2>
            <p class="text-xs text-gray-400 mb-4">API Keys are stored locally in your browser.</p>
            <input type="password" id="apiKeyInput" class="w-full bg-black border border-[#333] rounded-sm p-3 text-white mb-4 focus:outline-none focus:border-blue-500 text-sm font-mono" placeholder="Gemini API Key">
            <button onclick="saveApiKey()" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 rounded-sm transition-colors text-sm">SAVE CONFIGURATION</button>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast">Operation Successful</div>

    <!-- Main Content -->
    <main class="w-full max-w-7xl z-10 relative">
        
        <!-- Header -->
        <header class="mb-6 border-b border-[#262626] pb-6">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight text-white mb-1">
                        ROAD TO A MILLIE
                    </h1>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <p class="text-gray-500 font-mono text-[10px] tracking-widest uppercase">
                            Professional Investment Suite v2.0
                        </p>
                    </div>
                </div>
                <div class="text-right">
                    <button onclick="document.getElementById('apiModal').classList.remove('hidden')" class="text-xs text-gray-500 hover:text-white transition-colors flex items-center gap-1 ml-auto">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Settings
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex gap-1 bg-[#171717] p-1 rounded-md border border-[#262626] w-full max-w-md">
                <button onclick="switchTool('valuation')" id="nav-valuation" class="nav-btn active flex-1 py-2 text-[11px] font-bold uppercase tracking-wide rounded-sm">Valuation Model</button>
                <button onclick="switchTool('portfolio')" id="nav-portfolio" class="nav-btn flex-1 py-2 text-[11px] font-bold uppercase tracking-wide rounded-sm">Portfolio Tracker</button>
                <button onclick="switchTool('watchlist')" id="nav-watchlist" class="nav-btn flex-1 py-2 text-[11px] font-bold uppercase tracking-wide rounded-sm">Watchlist</button>
            </div>
        </header>

        <!-- TOOL 1: VALUATION TERMINAL -->
        <div id="view-valuation" class="tool-view grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- LEFT COLUMN: Smart Input -->
            <div class="lg:col-span-5">
                <div class="pro-panel p-5">
                    
                    <!-- Mode Toggle -->
                    <div class="flex border-b border-[#262626] pb-3 mb-4">
                        <button onclick="setMode('smart')" id="btnSmart" class="flex-1 text-xs font-bold text-blue-500 border-b-2 border-blue-500 pb-2">SMART EXTRACT</button>
                        <button onclick="setMode('manual')" id="btnManual" class="flex-1 text-xs font-bold text-gray-500 pb-2 hover:text-white transition-colors">MANUAL ENTRY</button>
                    </div>

                    <!-- SMART PASTE SECTION -->
                    <div id="smartSection">
                        <div class="mb-4">
                            <label>Target Ticker</label>
                            <div class="flex gap-2">
                                <input type="text" id="smartTicker" class="bg-black border border-[#333] rounded-sm p-2 text-white w-24 text-center font-bold uppercase" placeholder="AAPL">
                                <button onclick="openDataSource()" class="flex-1 bg-[#262626] hover:bg-[#333] border border-[#333] text-gray-300 text-xs font-bold rounded-sm flex items-center justify-center gap-2 transition-colors">
                                    <span>Open Yahoo Finance</span>
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label>Paste Data Source (Ctrl+A, Ctrl+C)</label>
                            
                            <!-- Language Selector -->
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-[10px] text-gray-500 uppercase font-bold">Locale:</span>
                                <select id="pasteLanguage" class="bg-[#262626] border border-[#333] rounded-sm px-2 py-0.5 text-[10px] text-gray-300 focus:outline-none cursor-pointer">
                                    <option value="en">English (US Format)</option>
                                    <option value="es">Espa√±ol (EU Format)</option>
                                    <option value="fr">Fran√ßais (EU Format)</option>
                                </select>
                            </div>

                            <textarea id="pasteArea" class="paste-zone w-full h-32 bg-black rounded-sm p-2 text-[10px] text-gray-400 font-mono resize-none focus:outline-none" placeholder="Paste data from Yahoo Finance here..."></textarea>
                        </div>

                        <button onclick="parseAndFill()" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 rounded-sm mb-4 transition-colors flex items-center justify-center gap-2 text-xs tracking-wide">
                            <span>EXTRACT FINANCIALS</span>
                            <span id="extractStatus" class="hidden text-[10px] bg-black/30 px-2 py-0.5 rounded">Reading...</span>
                        </button>
                    </div>

                    <!-- FORM -->
                    <form id="calcForm" onsubmit="event.preventDefault(); runAnalysis();" class="space-y-3 mt-6 border-t border-[#262626] pt-4">
                        
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-gray-400 uppercase">Valuation Inputs</span>
                            <span id="dataQualityBadge" class="text-[9px] bg-[#262626] text-gray-500 px-2 py-0.5 rounded border border-[#333]">NO DATA</span>
                        </div>

                        <!-- Core -->
                        <div class="grid grid-cols-3 gap-2">
                            <div class="input-group">
                                <label>Price</label>
                                <input type="number" step="0.01" id="price" required>
                            </div>
                            <div class="input-group">
                                <label>Shares (B)</label>
                                <input type="number" step="0.001" id="shares" required>
                            </div>
                            <div class="input-group">
                                <label>Raw Beta</label>
                                <input type="number" step="0.01" id="beta" placeholder="1.0">
                            </div>
                        </div>

                        <!-- Financials -->
                        <div class="grid grid-cols-2 gap-2">
                            <div class="input-group">
                                <div class="flex justify-between items-center mb-1">
                                    <label class="!mb-0">Net Income (TTM)</label>
                                    <button type="button" onclick="rollForwardNI()" class="text-[9px] bg-[#262626] hover:bg-[#333] text-gray-400 px-1.5 rounded border border-[#333] transition-colors" title="Project forward 1 year">‚è© Roll Fwd</button>
                                </div>
                                <input type="number" step="0.01" id="ni_ttm">
                            </div>
                            <div class="input-group">
                                <div class="flex justify-between items-center mb-1">
                                    <label class="!mb-0">FCF (TTM)</label>
                                    <button type="button" onclick="rollForward()" class="text-[9px] bg-[#262626] hover:bg-[#333] text-gray-400 px-1.5 rounded border border-[#333] transition-colors" title="Project forward 1 year">‚è© Roll Fwd</button>
                                </div>
                                <input type="number" step="0.01" id="fcf_ttm" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div class="input-group">
                                <label>Total Cash</label>
                                <input type="number" step="0.01" id="cash">
                            </div>
                            <div class="input-group">
                                <label>Total Debt</label>
                                <input type="number" step="0.01" id="debt">
                            </div>
                        </div>

                        <!-- Growth & Risk Assumptions -->
                        <div class="p-3 bg-[#111] rounded border border-[#262626]">
                            <label class="block text-[10px] text-gray-400 uppercase mb-2 text-center font-bold">Assumptions</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="input-group">
                                    <label>Growth Rate (%)</label>
                                    <input type="number" step="0.1" id="growth_rate" value="10.0">
                                </div>
                                <div class="input-group">
                                    <label>10Y Yield (RFR %)</label>
                                    <input type="number" step="0.01" id="rfr" value="4.2">
                                </div>
                            </div>
                            <div class="input-group mt-2">
                                <label>Valuation Model</label>
                                <select id="sector">
                                    <option value="tech">Standard Tech (DCF 15x Exit)</option>
                                    <option value="high_tech">High Growth (DCF 30x Exit)</option>
                                    <option value="industrial">Industrial (DCF 7x Exit)</option>
                                    <option value="bank">Financials (DDM)</option>
                                    <option value="reit">Real Estate (P/FFO)</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-emerald-700 hover:bg-emerald-600 text-white font-bold py-2.5 rounded-sm shadow-lg shadow-emerald-900/20 transition-all mt-4 text-xs tracking-wider">
                            CALCULATE INTRINSIC VALUE
                        </button>
                    </form>
                </div>
            </div>

            <!-- RIGHT COLUMN: Valuation Results -->
            <div class="lg:col-span-7 space-y-6">
                <div id="placeholderState" class="h-full flex flex-col items-center justify-center pro-panel p-10 text-center opacity-40 min-h-[500px]">
                    <div class="text-5xl mb-4 grayscale">üìä</div>
                    <h3 class="text-lg font-bold text-white mb-2">Awaiting Data</h3>
                    <p class="text-xs text-gray-500 font-mono">Use Smart Extract or enter data manually<br>to generate valuation model.</p>
                </div>

                <div id="resultsContainer" class="hidden space-y-4">
                    <!-- Executive Verdict -->
                    <div class="pro-panel p-6 border-l-4 border-gray-600 relative" id="verdictPanel">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-3xl font-bold text-white mb-1 tracking-tight" id="resTicker">TICKER</h2>
                                <p class="text-gray-500 text-xs uppercase tracking-wider font-mono">Equity Research Report</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold mb-1" id="resVerdict">--</div>
                                <div class="text-[10px] font-mono bg-[#262626] text-gray-300 px-2 py-1 rounded inline-block" id="resMargin">MOS: --%</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-[#262626]">
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Current Price</p>
                                <p class="text-lg font-mono text-white" id="resPrice">$0.00</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Intrinsic Value</p>
                                <p class="text-lg font-mono text-blue-400 font-bold" id="resIntrinsic">$0.00</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">WACC (Adj)</p>
                                <p class="text-lg font-mono text-white" id="resWacc">0.0%</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Market Cap</p>
                                <p class="text-sm font-mono text-white mt-1" id="resMktCap">$0B</p>
                            </div>
                        </div>
                        
                        <!-- Watchlist Integration Button -->
                        <div class="mt-4 pt-4 border-t border-[#262626] flex justify-end">
                            <button onclick="addValuationToWatchlist()" class="text-[10px] bg-[#262626] hover:bg-[#333] text-gray-300 border border-[#444] px-3 py-1.5 rounded-sm transition-colors flex items-center gap-2 uppercase font-bold tracking-wide">
                                <span>‚≠ê</span> Add to Watchlist
                            </button>
                        </div>
                    </div>

                    <!-- Metrics Breakdown -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Market Expectations -->
                        <div class="pro-panel p-5">
                            <h3 class="text-yellow-500 font-bold uppercase text-[10px] tracking-widest mb-3">Reverse DCF (Implied Growth)</h3>
                            <div class="bg-black p-4 rounded border border-[#262626] flex flex-col justify-center h-[100px]">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-500 text-[10px] uppercase">Priced-in Growth</span>
                                    <span class="text-xl font-mono font-bold text-white" id="impliedGrowth">0.0%</span>
                                </div>
                                <div class="w-full bg-[#262626] h-1.5 rounded-full overflow-hidden mb-2 relative">
                                    <div id="impliedMarker" class="absolute top-0 bottom-0 w-1 bg-white" style="left: 0%"></div>
                                    <div class="w-full h-full bg-gradient-to-r from-green-900 via-[#262626] to-red-900"></div>
                                </div>
                                <p class="text-[10px] text-gray-500 text-right font-mono" id="impliedSentiment">Status: Reality</p>
                            </div>
                        </div>

                        <!-- Financial Health -->
                        <div class="pro-panel p-5">
                            <h3 class="text-blue-500 font-bold uppercase text-[10px] tracking-widest mb-3">Financial Position</h3>
                            <div class="space-y-3">
                                <div class="bg-black p-2 rounded border border-[#262626]">
                                    <div class="flex justify-between text-[10px] mb-1">
                                        <span class="text-gray-500 uppercase">Balance Sheet</span>
                                        <span id="debtStatus" class="font-mono">Analyzing...</span>
                                    </div>
                                    <div class="flex items-center gap-1 h-2 w-full bg-[#262626] overflow-hidden">
                                        <div id="barCash" class="bg-green-600 h-full" style="width: 50%"></div>
                                        <div id="barDebt" class="bg-red-600 h-full" style="width: 50%"></div>
                                    </div>
                                    <div class="flex justify-between text-[9px] mt-1 text-gray-500 font-mono">
                                        <span>Cash: <span id="valCash" class="text-green-500">$0B</span></span>
                                        <span>Debt: <span id="valDebt" class="text-red-500">$0B</span></span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center px-1 border-b border-[#262626] pb-1">
                                    <span class="text-[10px] text-gray-500 uppercase">Net Income</span>
                                    <span class="text-sm font-mono text-white font-bold" id="valNi">$0B</span>
                                </div>
                                <div class="flex justify-between items-center px-1">
                                    <span class="text-[10px] text-gray-500 uppercase">FCF</span>
                                    <span class="text-sm font-mono text-blue-400 font-bold" id="valFcf">$0B</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOOL 2: PORTFOLIO TRACKER -->
        <div id="view-portfolio" class="tool-view hidden max-w-6xl mx-auto">
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Add Position Form -->
                <div class="lg:col-span-4">
                    <div class="pro-panel p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                                <span class="w-1.5 h-1.5 bg-blue-600 rounded-sm"></span>
                                New Trade
                            </h2>
                        </div>
                        <form id="portfolioForm" onsubmit="event.preventDefault(); addPosition();" class="space-y-4">
                            <div class="input-group relative">
                                <label>Ticker</label>
                                <div class="flex gap-2">
                                    <input type="text" id="pf_ticker" placeholder="e.g. AAPL" class="uppercase font-bold" required>
                                    <button type="button" onclick="autoFillPortfolio()" id="btnAutoFill" class="bg-[#262626] border border-[#333] text-gray-400 px-3 rounded-sm hover:bg-[#333] hover:text-white transition-colors text-xs flex items-center gap-1 font-bold" title="Auto-fill price and sector via AI">
                                        <span>üîç</span>
                                    </button>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Sector</label>
                                <select id="pf_sector" required>
                                    <option value="Technology">Technology</option>
                                    <option value="Financials">Financials</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Consumer">Consumer</option>
                                    <option value="Energy">Energy</option>
                                    <option value="Industrial">Industrial</option>
                                    <option value="Real Estate">Real Estate</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Shares</label>
                                <input type="number" step="0.001" id="pf_shares" placeholder="0" required>
                            </div>
                            <div class="input-group">
                                <label>Buy Price ($)</label>
                                <input type="number" step="0.01" id="pf_price" placeholder="0.00" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2.5 rounded-sm shadow-lg shadow-blue-900/20 transition-all text-xs tracking-widest">
                                ADD POSITION
                            </button>
                        </form>
                    </div>
                    
                    <!-- Portfolio Summary -->
                    <div class="pro-panel p-6 mt-6 bg-[#111]">
                        <h3 class="text-[10px] text-gray-500 uppercase font-bold mb-4 tracking-widest">Net Liquidation Value</h3>
                        <p class="text-3xl font-mono font-bold text-white mb-1" id="totalValue">$0.00</p>
                        <div class="flex items-center gap-2 border-t border-[#262626] pt-2 mt-2" id="totalPnLContainer">
                            <span class="text-xs font-mono text-gray-400" id="totalPnL">Total PnL: $0.00 (0.00%)</span>
                        </div>
                    </div>
                </div>

                <!-- Positions & Charts -->
                <div class="lg:col-span-8 space-y-6 flex flex-col">
                    
                    <!-- Positions Table (First) -->
                    <div class="pro-panel p-0 min-h-[300px] overflow-hidden">
                        <div class="flex justify-between items-center p-4 border-b border-[#262626] bg-[#111]">
                            <h2 class="text-sm font-bold text-white uppercase tracking-wider">Open Positions</h2>
                            <button onclick="updatePricesViaAI()" id="btnUpdatePrices" class="text-[10px] bg-[#262626] hover:bg-[#333] text-gray-300 border border-[#333] px-3 py-1.5 rounded-sm flex items-center gap-2 transition-colors font-bold">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                REFRESH QUOTES
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left">
                                <thead class="text-[10px] text-gray-500 uppercase bg-[#0f0f0f] border-b border-[#262626]">
                                    <tr>
                                        <th class="px-4 py-3">Ticker</th>
                                        <th class="px-4 py-3">Sector</th>
                                        <th class="px-4 py-3 text-right">Avg Cost</th>
                                        <th class="px-4 py-3 text-right">Qty</th>
                                        <th class="px-4 py-3 text-right w-24">Last Price</th>
                                        <th class="px-4 py-3 text-right">Mkt Value</th>
                                        <th class="px-4 py-3 text-right">Unrealized P/L</th>
                                        <th class="px-4 py-3 text-center"></th>
                                    </tr>
                                </thead>
                                <tbody id="portfolioTableBody" class="text-gray-300 font-mono">
                                    <!-- Rows injected here -->
                                </tbody>
                            </table>
                            <div id="emptyPortfolio" class="text-center py-10 text-gray-600 hidden text-xs font-sans">
                                No open positions.
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Charts (Second) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="pro-panel p-4">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest">Exposure by Asset</h3>
                            <div class="h-40 relative"><canvas id="chartCompany"></canvas></div>
                        </div>
                        <div class="pro-panel p-4">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest">Exposure by Sector</h3>
                            <div class="h-40 relative"><canvas id="chartSector"></canvas></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- TOOL 3: WATCHLIST -->
        <div id="view-watchlist" class="tool-view hidden max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Watchlist Input -->
                <div class="lg:col-span-4">
                    <div class="pro-panel p-6">
                        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-yellow-600 rounded-sm"></span>
                            Track Stock
                        </h2>
                        <form id="watchlistForm" onsubmit="event.preventDefault(); addToWatchlistManual();" class="space-y-4">
                            <div class="input-group">
                                <label>Ticker</label>
                                <input type="text" id="wl_ticker" placeholder="e.g. MSFT" class="uppercase font-bold" required>
                            </div>
                            <div class="input-group">
                                <label>Target Buy Price</label>
                                <input type="number" step="0.01" id="wl_target" placeholder="0.00" required>
                            </div>
                            <div class="input-group">
                                <label>Current Price</label>
                                <input type="number" step="0.01" id="wl_price" placeholder="0.00">
                            </div>
                            <button type="submit" class="w-full bg-[#262626] hover:bg-[#333] border border-yellow-700/30 text-yellow-500 font-bold py-2.5 rounded-sm transition-all text-xs tracking-widest">
                                ADD TO WATCHLIST
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Watchlist Table -->
                <div class="lg:col-span-8">
                    <div class="pro-panel p-0 min-h-[400px] overflow-hidden">
                        <div class="flex justify-between items-center p-4 border-b border-[#262626] bg-[#111]">
                            <h2 class="text-sm font-bold text-white uppercase tracking-wider">Price Targets</h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left">
                                <thead class="text-[10px] text-gray-500 uppercase bg-[#0f0f0f] border-b border-[#262626]">
                                    <tr>
                                        <th class="px-4 py-3">Ticker</th>
                                        <th class="px-4 py-3 text-right">Target (Intrinsic)</th>
                                        <th class="px-4 py-3 text-right w-24">Last Price</th>
                                        <th class="px-4 py-3 text-right">Margin of Safety</th>
                                        <th class="px-4 py-3 text-center"></th>
                                    </tr>
                                </thead>
                                <tbody id="watchlistTableBody" class="text-gray-300 font-mono">
                                    <!-- Rows injected here -->
                                </tbody>
                            </table>
                            <div id="emptyWatchlist" class="text-center py-10 text-gray-600 hidden text-xs font-sans">
                                Watchlist is empty.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Configuration ---
        let apiKey = localStorage.getItem('gemini_api_key') || '';

        // --- Confirmation Modal Logic ---
        let pendingAction = null;

        function requestDelete(action, id) {
            const modal = document.getElementById('confirmModal');
            const msg = document.getElementById('confirmMessage');
            const btn = document.getElementById('confirmBtn');
            
            if (action === 'position') {
                msg.innerText = "Are you sure you want to close this position? This cannot be undone.";
                // Need to wrap in arrow function to preserve ID
                document.getElementById('confirmBtn').onclick = function() { deletePosition(id); closeConfirm(); };
            } else if (action === 'watchlist') {
                msg.innerText = "Remove this stock from your watchlist?";
                document.getElementById('confirmBtn').onclick = function() { deleteWatchlistItem(id); closeConfirm(); };
            }
            
            modal.classList.remove('hidden');
        }

        function closeConfirm() {
            document.getElementById('confirmModal').classList.add('hidden');
        }

        // --- 1. Navigation & State ---
        function switchTool(toolName) {
            document.querySelectorAll('.tool-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`view-${toolName}`).classList.remove('hidden');
            document.getElementById(`nav-${toolName}`).classList.add('active');
            
            if(toolName === 'portfolio') {
                renderPortfolio();
                setTimeout(renderCharts, 100);
            }
            if(toolName === 'watchlist') renderWatchlist();
        }

        function setMode(mode) {
            const smart = document.getElementById('smartSection');
            const btnSmart = document.getElementById('btnSmart');
            const btnManual = document.getElementById('btnManual');

            if(mode === 'smart') {
                smart.classList.remove('hidden');
                btnSmart.className = "flex-1 text-xs font-bold text-blue-500 border-b-2 border-blue-500 pb-2";
                btnManual.className = "flex-1 text-xs font-bold text-gray-500 pb-2 hover:text-white transition-colors";
            } else {
                smart.classList.add('hidden');
                btnManual.className = "flex-1 text-xs font-bold text-blue-500 border-b-2 border-blue-500 pb-2";
                btnSmart.className = "flex-1 text-xs font-bold text-gray-500 pb-2 hover:text-white transition-colors";
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value;
            if (input) {
                apiKey = input;
                localStorage.setItem('gemini_api_key', apiKey);
            }
            document.getElementById('apiModal').classList.add('hidden');
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- 2. Portfolio Logic ---
        let portfolio = JSON.parse(localStorage.getItem('millie_portfolio')) || [];
        portfolio = portfolio.map(p => ({...p, id: p.id || crypto.randomUUID(), sector: p.sector || 'Other'}));

        // --- 3. Watchlist Logic ---
        let watchlist = JSON.parse(localStorage.getItem('millie_watchlist')) || [];
        watchlist = watchlist.map(w => ({...w, id: w.id || crypto.randomUUID()}));

        function addToWatchlist(ticker, target, current) {
            const exists = watchlist.find(w => w.ticker === ticker);
            if (exists) {
                exists.targetPrice = parseFloat(target);
                exists.currentPrice = parseFloat(current);
            } else {
                watchlist.push({
                    id: crypto.randomUUID(),
                    ticker: ticker,
                    targetPrice: parseFloat(target),
                    currentPrice: parseFloat(current)
                });
            }
            saveWatchlist();
            renderWatchlist();
            showToast(`Tracking ${ticker}`);
        }

        function addToWatchlistManual() {
            const ticker = document.getElementById('wl_ticker').value.toUpperCase();
            const target = document.getElementById('wl_target').value;
            const current = document.getElementById('wl_price').value || 0;
            
            if(!ticker || !target) return;
            addToWatchlist(ticker, target, current);
            document.getElementById('watchlistForm').reset();
        }

        function addValuationToWatchlist() {
            const ticker = document.getElementById('smartTicker').value.toUpperCase() || document.getElementById('resTicker').innerText;
            const intrinsic = parseFloat(document.getElementById('resIntrinsic').innerText.replace('$',''));
            const current = parseFloat(document.getElementById('resPrice').innerText.replace('$',''));
            
            if (!intrinsic || intrinsic === 0) return alert("Calculate a valuation first.");
            
            addToWatchlist(ticker, intrinsic, current);
        }

        function deleteWatchlistItem(id) {
            watchlist = watchlist.filter(w => w.id !== id);
            saveWatchlist();
            renderWatchlist();
        }

        function updateWatchlistPrice(id, price) {
            const idx = watchlist.findIndex(w => w.id === id);
            if(idx >= 0) {
                watchlist[idx].currentPrice = parseFloat(price) || 0;
                saveWatchlist();
                renderWatchlist();
            }
        }

        function saveWatchlist() {
            localStorage.setItem('millie_watchlist', JSON.stringify(watchlist));
        }

        function renderWatchlist() {
            const tbody = document.getElementById('watchlistTableBody');
            tbody.innerHTML = '';
            
            if(watchlist.length === 0) {
                document.getElementById('emptyWatchlist').classList.remove('hidden');
            } else {
                document.getElementById('emptyWatchlist').classList.add('hidden');
                
                watchlist.forEach((item) => {
                    let mos = 0;
                    if(item.currentPrice > 0) {
                        mos = ((item.targetPrice - item.currentPrice) / item.currentPrice) * 100;
                    }
                    
                    const mosColor = mos > 0 ? 'text-green-500' : 'text-red-500';
                    const mosText = mos > 0 ? `Undervalued (${mos.toFixed(1)}%)` : `Premium (${Math.abs(mos).toFixed(1)}%)`;

                    const row = document.createElement('tr');
                    row.className = "hover:bg-[#1a1a1a] transition-colors border-b border-[#262626]";
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 font-bold text-white font-sans">${item.ticker}</td>
                        <td class="px-4 py-3 text-right text-blue-400 font-bold">$${item.targetPrice.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right">
                            <input type="number" step="0.01" value="${item.currentPrice}" 
                                onchange="updateWatchlistPrice('${item.id}', this.value)"
                                class="bg-[#0a0a0a] border border-[#333] rounded-sm px-1 py-0.5 w-20 text-right text-white focus:border-blue-500 outline-none">
                        </td>
                        <td class="px-4 py-3 text-right ${mosColor} font-bold">
                            ${mosText}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="requestDelete('watchlist', '${item.id}')" class="text-gray-600 hover:text-red-500 transition-colors font-bold text-lg">√ó</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // --- 4. Auto Fill & AI Logic ---
        async function autoFillPortfolio() {
            if(!apiKey) {
                document.getElementById('apiModal').classList.remove('hidden');
                return;
            }
            
            const ticker = document.getElementById('pf_ticker').value.toUpperCase();
            if(!ticker) return alert("Enter a ticker first!");

            const btn = document.getElementById('btnAutoFill');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `...`;
            btn.disabled = true;

            try {
                const prompt = `Find the current real-time stock price and business sector for ${ticker}. 
                Return strictly a JSON object with this format: {"price": number, "sector": "SectorName"}.
                Use standard GICS sectors like Technology, Financials, Healthcare, Consumer, Energy, Industrial, Real Estate, Utilities.`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ google_search: {} }]
                    })
                });

                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text;
                
                const firstOpen = text.indexOf('{');
                const lastClose = text.lastIndexOf('}');
                if (firstOpen !== -1 && lastClose !== -1) {
                    const jsonStr = text.substring(firstOpen, lastClose + 1);
                    const result = JSON.parse(jsonStr);
                    
                    if(result.price) document.getElementById('pf_price').value = result.price;
                    if(result.sector) {
                        const select = document.getElementById('pf_sector');
                        let matched = false;
                        for(let i=0; i<select.options.length; i++) {
                            if(select.options[i].value.toLowerCase().includes(result.sector.toLowerCase()) || 
                               result.sector.toLowerCase().includes(select.options[i].value.toLowerCase())) {
                                select.selectedIndex = i;
                                matched = true;
                                break;
                            }
                        }
                        if(!matched) select.value = "Other";
                    }
                }
            } catch(e) {
                console.error(e);
                alert("Auto-fill failed. Please enter manually.");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // --- 5. Portfolio Functions ---
        function addPosition() {
            const ticker = document.getElementById('pf_ticker').value.toUpperCase();
            const sector = document.getElementById('pf_sector').value;
            const shares = parseFloat(document.getElementById('pf_shares').value);
            const price = parseFloat(document.getElementById('pf_price').value);

            if(!ticker || isNaN(shares) || isNaN(price)) return;

            const existingIndex = portfolio.findIndex(p => p.ticker === ticker);

            if(existingIndex >= 0) {
                const oldPos = portfolio[existingIndex];
                const totalCost = (oldPos.shares * oldPos.avgPrice) + (shares * price);
                const totalShares = oldPos.shares + shares;
                
                portfolio[existingIndex].shares = totalShares;
                portfolio[existingIndex].avgPrice = totalCost / totalShares;
                portfolio[existingIndex].sector = sector; 
            } else {
                portfolio.push({ 
                    id: crypto.randomUUID(),
                    ticker, 
                    sector, 
                    shares, 
                    avgPrice: price, 
                    currentPrice: price 
                });
            }

            savePortfolio();
            document.getElementById('portfolioForm').reset();
            renderPortfolio();
            renderCharts();
        }

        function deletePosition(id) {
            portfolio = portfolio.filter(p => p.id !== id);
            savePortfolio();
            renderPortfolio();
            renderCharts();
        }

        function updateCurrentPrice(id, newPrice) {
            const idx = portfolio.findIndex(p => p.id === id);
            if(idx >= 0) {
                portfolio[idx].currentPrice = parseFloat(newPrice) || 0;
                savePortfolio();
                renderPortfolio();
                renderCharts();
            }
        }

        async function updatePricesViaAI() {
            if(!apiKey) {
                document.getElementById('apiModal').classList.remove('hidden');
                return;
            }
            
            const btn = document.getElementById('btnUpdatePrices');
            const originalText = btn.innerHTML;
            btn.innerHTML = `UPLOADING...`;
            btn.disabled = true;

            const tickers = portfolio.map(p => p.ticker).join(", ");
            if(!tickers) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const prompt = `Search for the current real-time stock prices for: ${tickers}. Return ONLY a JSON object where keys are tickers and values are numbers (prices). Example: {"AAPL": 150.25, "NVDA": 420.00}`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ google_search: {} }]
                    })
                });

                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text;
                
                const firstOpen = text.indexOf('{');
                const lastClose = text.lastIndexOf('}');
                if (firstOpen !== -1 && lastClose !== -1) {
                    const jsonStr = text.substring(firstOpen, lastClose + 1);
                    const prices = JSON.parse(jsonStr);
                    
                    portfolio.forEach(p => {
                        if(prices[p.ticker]) {
                            p.currentPrice = prices[p.ticker];
                        }
                    });
                    savePortfolio();
                    renderPortfolio();
                    renderCharts();
                }
            } catch (e) {
                console.error(e);
                alert("Price update failed. Check API Key or try again later.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function savePortfolio() {
            localStorage.setItem('millie_portfolio', JSON.stringify(portfolio));
        }

        // --- 6. Charts Logic ---
        let chartCompany = null;
        let chartSector = null;

        function renderCharts() {
            if(portfolio.length === 0) return;

            const companyData = portfolio.map(p => p.shares * p.currentPrice);
            const companyLabels = portfolio.map(p => p.ticker);
            const totalValue = companyData.reduce((a, b) => a + b, 0);
            
            const sectorMap = {};
            portfolio.forEach(p => {
                const val = p.shares * p.currentPrice;
                sectorMap[p.sector] = (sectorMap[p.sector] || 0) + val;
            });
            
            // Custom Tooltip Callback for Percentages
            const percentageTooltip = {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        let value = context.raw || 0;
                        let percentage = totalValue > 0 ? Math.round((value / totalValue) * 100) : 0;
                        return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                    }
                },
                backgroundColor: 'rgba(23, 23, 23, 0.9)',
                titleColor: '#fff',
                bodyColor: '#ccc',
                borderColor: '#333',
                borderWidth: 1,
                padding: 10,
                cornerRadius: 4
            };

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#a3a3a3', font: {size: 10, family: 'Inter'} }, boxWidth: 10 },
                    tooltip: percentageTooltip
                },
                layout: { padding: 0 }
            };

            const ctxComp = document.getElementById('chartCompany').getContext('2d');
            if(chartCompany) chartCompany.destroy();
            chartCompany = new Chart(ctxComp, {
                type: 'doughnut',
                data: {
                    labels: companyLabels,
                    datasets: [{
                        data: companyData,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: commonOptions
            });

            const ctxSec = document.getElementById('chartSector').getContext('2d');
            if(chartSector) chartSector.destroy();
            chartSector = new Chart(ctxSec, {
                type: 'pie',
                data: {
                    labels: Object.keys(sectorMap),
                    datasets: [{
                        data: Object.values(sectorMap),
                        backgroundColor: ['#2563eb', '#0d9488', '#ea580c', '#65a30d', '#9333ea'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: commonOptions
            });
        }

        function renderPortfolio() {
            const tbody = document.getElementById('portfolioTableBody');
            tbody.innerHTML = '';
            
            let totalVal = 0;
            let totalCost = 0;

            if(portfolio.length === 0) {
                document.getElementById('emptyPortfolio').classList.remove('hidden');
            } else {
                document.getElementById('emptyPortfolio').classList.add('hidden');
                
                portfolio.forEach((pos, index) => {
                    const marketVal = pos.shares * pos.currentPrice;
                    const costBasis = pos.shares * pos.avgPrice;
                    const pnl = marketVal - costBasis;
                    const pnlPct = costBasis > 0 ? (pnl / costBasis) * 100 : 0;
                    
                    totalVal += marketVal;
                    totalCost += costBasis;

                    const row = document.createElement('tr');
                    row.className = "border-b border-[#262626] hover:bg-[#1a1a1a] transition-colors";
                    
                    const pnlColor = pnl >= 0 ? 'text-green-500' : 'text-red-500';
                    const pnlSign = pnl >= 0 ? '+' : '';

                    row.innerHTML = `
                        <td class="px-4 py-3 font-bold text-white font-sans">${pos.ticker}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 font-sans">${pos.sector}</td>
                        <td class="px-4 py-3 text-right text-gray-400">$${pos.avgPrice.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right text-gray-400">${pos.shares}</td>
                        <td class="px-4 py-3 text-right">
                            <input type="number" step="0.01" value="${pos.currentPrice}" 
                                onchange="updateCurrentPrice('${pos.id}', this.value)"
                                class="bg-[#0a0a0a] border border-[#333] rounded-sm px-1 py-0.5 w-20 text-right text-white focus:border-blue-500 outline-none">
                        </td>
                        <td class="px-4 py-3 text-right font-bold text-white">$${marketVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-4 py-3 text-right font-bold ${pnlColor}">
                            <div>${pnlSign}$${pnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="text-[10px] opacity-70">${pnlSign}${pnlPct.toFixed(2)}%</div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="requestDelete('position', '${pos.id}')" class="text-gray-600 hover:text-red-500 transition-colors font-bold text-lg">√ó</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            const totalPnL = totalVal - totalCost;
            const totalPnLPct = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;
            const totalSign = totalPnL >= 0 ? '+' : '';
            const totalColor = totalPnL >= 0 ? 'text-green-500' : 'text-red-500';

            document.getElementById('totalValue').innerText = `$${totalVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalPnL').innerHTML = `<span class="${totalColor}">${totalSign}$${totalPnL.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${totalSign}${totalPnLPct.toFixed(2)}%)</span>`;
        }


        // --- 7. Smart Parser Logic (Valuation Tool) ---
        function openDataSource() {
            const ticker = document.getElementById('smartTicker').value;
            if(!ticker) return alert("Enter a ticker first!");
            window.open(`https://finance.yahoo.com/quote/${ticker}/key-statistics/`, '_blank');
        }

        function rollForward() {
            const fcfInput = document.getElementById('fcf_ttm');
            const growthInput = document.getElementById('growth_rate');
            let fcf = parseFloat(fcfInput.value);
            let growth = parseFloat(growthInput.value);
            if (isNaN(fcf)) return alert("Enter a starting FCF value first.");
            if (isNaN(growth)) growth = 0; 
            const forwardFcf = fcf * (1 + (growth / 100));
            fcfInput.value = forwardFcf.toFixed(2);
            gsap.from(fcfInput, { backgroundColor: "rgba(16, 185, 129, 0.4)", duration: 0.5, clearProps: "backgroundColor" });
        }

        function rollForwardNI() {
            const niInput = document.getElementById('ni_ttm');
            const growthInput = document.getElementById('growth_rate');
            let ni = parseFloat(niInput.value);
            let growth = parseFloat(growthInput.value);
            if (isNaN(ni)) return alert("Enter a starting Net Income value first.");
            if (isNaN(growth)) growth = 0;
            const forwardNi = ni * (1 + (growth / 100));
            niInput.value = forwardNi.toFixed(2);
            gsap.from(niInput, { backgroundColor: "rgba(16, 185, 129, 0.4)", duration: 0.5, clearProps: "backgroundColor" });
        }

        function parseAndFill() {
            let text = document.getElementById('pasteArea').value.toLowerCase();
            const lang = document.getElementById('pasteLanguage').value; 
            
            if(!text) return alert("Paste some data first!");

            document.getElementById('extractStatus').classList.remove('hidden');
            text = text.replace(/\s+/g, ' ');

            const labels = {
                en: {
                    shares: ["shares outstanding 5", "shares outstanding", "implied shares outstanding"],
                    beta: ["beta (5y monthly)", "beta (5-year monthly)"],
                    netIncome: ["net income avl to common (ttm)", "net income avl to common", "net income available to common", "net income"],
                    fcf: ["levered free cash flow (ttm)", "levered free cash flow", "free cash flow"],
                    cash: ["total cash (mrq)", "total cash"],
                    debt: ["total debt (mrq)", "total debt"],
                    priceAnchor: "previous close"
                },
                es: {
                    shares: ["acciones en circulaci√≥n 5", "acciones en circulaci√≥n", "acciones en circulacion"],
                    beta: ["beta (5 a", "beta (5y"],
                    netIncome: ["ingresos netos disponibles", "ingreso neto disponible", "ingreso neto"],
                    fcf: ["flujo de efectivo apalancado", "flujo de caja libre", "flujo de efectivo libre"],
                    cash: ["efectivo total", "total de efectivo"],
                    debt: ["endeudamiento total", "deuda total"],
                    priceAnchor: ["cierre anterior", "cierre previo"]
                },
                fr: {
                    shares: ["actions en attente 5", "actions en attente", "actions en circulation", "nombre d'actions"],
                    beta: ["b√™ta (mensuel sur 5 ans)", "b√™ta (mensuel", "b√™ta (5", "beta (mensuel"],
                    netIncome: ["b√©n√©fice net disponible distribuable", "r√©sultat net part du groupe", "b√©n√©fice net"],
                    fcf: ["effet de levier de flux de tr√©sorerie libre", "flux de tr√©sorerie disponible", "free cash flow"],
                    cash: ["tr√©sorerie totale", "disponibilit√©s totales"],
                    debt: ["dette totale"],
                    priceAnchor: "cl√¥ture pr√©c√©dente"
                }
            };

            const currentLabels = labels[lang];

            function extractNumber(labelKeys) {
                const keys = Array.isArray(labelKeys) ? labelKeys : [labelKeys];
                for (let key of keys) {
                    const safeKey = key.replace(/[()]/g, "\\$&"); 
                    const regex = new RegExp(`${safeKey}.{0,60}?([0-9-][0-9.,\\s]*[BTMkMd]*)`, 'i');
                    const match = text.match(regex);
                    if(match && match[1]) {
                        const raw = match[1].trim();
                        if (/[0-9]/.test(raw)) {
                            return parseFinancialString(raw);
                        }
                    }
                }
                return null;
            }

            function extractPrice() {
                const regex = /([0-9.,]+)\s*[+-]?[0-9.,]+\s*\(/;
                const match = text.match(regex);
                if (match && match[1]) {
                    return parseFinancialString(match[1]);
                }
                return extractNumber(currentLabels.priceAnchor) || 0;
            }

            function parseFinancialString(str) {
                str = str.trim().toUpperCase();
                str = str.replace(/\s/g, ''); 
                
                let valStr = str;
                let multiplier = 1;
                
                if(str.includes('T')) { multiplier = 1000; valStr = str.replace('T',''); }
                else if(str.includes('B')) { multiplier = 1; valStr = str.replace('B',''); } 
                else if(str.includes('M') && !str.includes('MD') && !str.includes('MM')) { multiplier = 0.001; valStr = str.replace('M',''); }
                else if(str.includes('MD')) { multiplier = 1; valStr = str.replace('MDS','').replace('MD',''); }
                else if(str.includes('MM')) { multiplier = 1; valStr = str.replace('MM',''); }
                else if(str.includes('K')) { multiplier = 0.000001; valStr = str.replace('K',''); }

                valStr = valStr.replace(/[A-Z]/g, '');

                if (lang === 'en') {
                    valStr = valStr.replace(/,/g, '');
                } else {
                    valStr = valStr.replace(/\./g, '').replace(',', '.');
                }
                
                return parseFloat(valStr) * multiplier;
            }

            try {
                let price = extractPrice();
                if(price) document.getElementById('price').value = price;
                let shares = extractNumber(currentLabels.shares);
                if(shares) document.getElementById('shares').value = shares;
                let beta = extractNumber(currentLabels.beta);
                if(beta) document.getElementById('beta').value = beta;
                let ni = extractNumber(currentLabels.netIncome);
                if(ni) document.getElementById('ni_ttm').value = ni;
                let fcf = extractNumber(currentLabels.fcf);
                if(fcf) document.getElementById('fcf_ttm').value = fcf;
                let cash = extractNumber(currentLabels.cash);
                if(cash) document.getElementById('cash').value = cash;
                let debt = extractNumber(currentLabels.debt);
                if(debt) document.getElementById('debt').value = debt;

                document.getElementById('dataQualityBadge').innerText = "DATA EXTRACTED";
                document.getElementById('dataQualityBadge').className = "text-[9px] bg-green-900 text-green-400 px-2 py-0.5 rounded border border-green-700";
                document.getElementById('extractStatus').innerText = "Success";
                gsap.from("#calcForm input", { borderColor: "#10b981", duration: 0.5, clearProps: "all" });
            } catch (e) {
                console.error(e);
                alert("Could not parse data. Check language selection.");
                document.getElementById('extractStatus').classList.add('hidden');
            }
        }

        // --- 8. Valuation Logic ---
        function runAnalysis() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const shares = parseFloat(document.getElementById('shares').value) || 0;
            const rawBeta = parseFloat(document.getElementById('beta').value) || 1.0;
            const ni = parseFloat(document.getElementById('ni_ttm').value) || 0;
            const fcf = parseFloat(document.getElementById('fcf_ttm').value) || 0;
            const cash = parseFloat(document.getElementById('cash').value) || 0;
            const debt = parseFloat(document.getElementById('debt').value) || 0;
            const growthRate = parseFloat(document.getElementById('growth_rate').value) / 100;
            const sector = document.getElementById('sector').value;
            const rfrInput = parseFloat(document.getElementById('rfr').value) || 4.2;
            const rfr = rfrInput / 100;

            const adjBeta = (0.67 * rawBeta) + (0.33 * 1.0);
            const wacc = rfr + (adjBeta * 0.055); 

            let intrinsicVal = 0;
            let exitMultiple = 15;

            if (sector === 'bank') {
                let g = Math.min(growthRate, 0.03); 
                intrinsicVal = (ni / shares) / (wacc - g);
            } else if (sector === 'reit') {
                intrinsicVal = (fcf / shares) * 15; 
            } else {
                if (sector === 'tech') exitMultiple = 15;
                if (sector === 'high_tech') exitMultiple = 30;
                if (sector === 'industrial') exitMultiple = 7;
                
                let sumPV = 0;
                let futureFCF = fcf;
                for(let i=1; i<=10; i++) {
                    let g = growthRate - ((growthRate - 0.03) * (i/10));
                    futureFCF = futureFCF * (1 + g);
                    sumPV += futureFCF / Math.pow(1 + wacc, i);
                }
                let termVal = futureFCF * exitMultiple;
                let pvTerm = termVal / Math.pow(1 + wacc, 10);
                let enterpriseValue = sumPV + pvTerm;
                let equityValue = enterpriseValue + cash - debt;
                intrinsicVal = equityValue / shares;
            }

            const mos = ((intrinsicVal - price) / price) * 100;
            let verdict = "HOLD";
            let verdictColorClass = "text-gray-300";
            let panelBorderClass = "border-gray-500";
            let mosBgClass = "bg-gray-800 text-gray-300";

            if (mos > 15) {
                verdict = "BUY";
                verdictColorClass = "text-green-500";
                panelBorderClass = "border-green-600";
                mosBgClass = "bg-green-900/30 text-green-400 border border-green-800";
            } else if (mos < -10) {
                verdict = "SELL";
                verdictColorClass = "text-red-500";
                panelBorderClass = "border-red-600";
                mosBgClass = "bg-red-900/30 text-red-400 border border-red-800";
            } else {
                verdict = "HOLD"; 
                verdictColorClass = "text-gray-200"; 
                panelBorderClass = "border-gray-500"; 
                mosBgClass = "bg-gray-800 text-gray-300 border border-gray-600";
            }

            let impliedG = 0;
            if (sector !== 'bank' && sector !== 'reit') {
                let low = -0.50;
                let high = 1.00;
                for(let i=0; i<20; i++) { 
                    let mid = (low + high) / 2;
                    let testVal = 0;
                    let testFCF = fcf;
                    let testSumPV = 0;
                    for(let j=1; j<=10; j++) {
                        let g = mid - ((mid - 0.03) * (j/10));
                        testFCF = testFCF * (1 + g);
                        testSumPV += testFCF / Math.pow(1 + wacc, j);
                    }
                    let testTerm = testFCF * exitMultiple;
                    let testPVTerm = testTerm / Math.pow(1 + wacc, 10);
                    let testEqV = (testSumPV + testPVTerm + cash - debt) / shares;
                    if (testEqV > price) high = mid;
                    else low = mid;
                }
                impliedG = (low + high) / 2;
            }

            document.getElementById('placeholderState').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');

            const ticker = document.getElementById('smartTicker').value || "STOCK";
            document.getElementById('resTicker').innerText = ticker.toUpperCase();
            
            const vEl = document.getElementById('resVerdict');
            const pEl = document.getElementById('verdictPanel');
            const mEl = document.getElementById('resMargin');
            
            vEl.innerText = verdict;
            vEl.className = `text-2xl font-bold mb-1 ${verdictColorClass}`;
            pEl.className = `pro-panel p-6 border-l-4 ${panelBorderClass} relative`;
            mEl.innerText = `MOS: ${mos.toFixed(1)}%`;
            mEl.className = `text-[10px] font-mono px-2 py-1 rounded inline-block ${mosBgClass}`;

            document.getElementById('resPrice').innerText = `$${price.toFixed(2)}`;
            document.getElementById('resIntrinsic').innerText = `$${intrinsicVal.toFixed(2)}`;
            document.getElementById('resWacc').innerText = `${(wacc*100).toFixed(1)}%`;
            document.getElementById('resMktCap').innerText = `$${(price*shares).toFixed(1)}B`;

            let impliedPct = (impliedG * 100);
            if (sector === 'bank' || sector === 'reit') impliedPct = 0; 
            
            document.getElementById('impliedGrowth').innerText = `${impliedPct.toFixed(1)}%`;
            let markerPos = ((impliedPct) / 20) * 100;
            if (markerPos < 0) markerPos = 0;
            if (markerPos > 100) markerPos = 100;
            document.getElementById('impliedMarker').style.left = `${markerPos}%`;
            
            let sentiment = "Reality";
            if (impliedPct > 15) sentiment = "High Optimism";
            else if (impliedPct < 2) sentiment = "Pessimism";
            document.getElementById('impliedSentiment').innerText = `Implied: ${sentiment}`;

            document.getElementById('valNi').innerText = `$${ni}B`;
            document.getElementById('valFcf').innerText = `$${fcf}B`;
            document.getElementById('valCash').innerText = `$${cash}B`;
            document.getElementById('valDebt').innerText = `$${debt}B`;
            
            const totalCap = cash + debt + 0.1; 
            document.getElementById('barCash').style.width = `${(cash/totalCap)*100}%`;
            document.getElementById('barDebt').style.width = `${(debt/totalCap)*100}%`;
            
            if(debt > cash * 3) {
                document.getElementById('debtStatus').innerHTML = '<span class="text-red-400">High Leverage</span>';
            } else if (cash > debt) {
                document.getElementById('debtStatus').innerHTML = '<span class="text-green-400">Net Cash</span>';
            } else {
                document.getElementById('debtStatus').innerHTML = '<span class="text-yellow-400">Moderate</span>';
            }

            document.getElementById('outRfr').innerText = `${rfrInput.toFixed(1)}%`;
            document.getElementById('outBeta').innerText = `${adjBeta.toFixed(2)} (Adj)`;
            document.getElementById('outWaccCalc').innerText = `${(wacc*100).toFixed(1)}%`;
            document.getElementById('outFair').innerText = `$${intrinsicVal.toFixed(2)}`;
            document.getElementById('outEV').innerText = `EV: ~$${(intrinsicVal*shares - cash + debt).toFixed(1)}B`;
            document.getElementById('outEqV').innerText = `EqV: ~$${(intrinsicVal*shares).toFixed(1)}B`;

            gsap.from("#resultsContainer > div", { y: 20, opacity: 0, stagger: 0.1 });
        }
    </script>
</body>
</html>
